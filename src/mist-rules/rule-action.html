<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="mist-dropdown-multi.html">

<dom-module id="rule-action">
    <template>
		<style>
		paper-button {
            padding: 0.8em 1.57em 0.7em 1.57em;
            font-weight: 500;
        }
        paper-button[disabled] {
            background-color: rgba(0,0,0,.13) !important;
            color: rgba(0,0,0,0.32) !important;
        }
        paper-material {
            border-top: 2px solid #ddd;
        }
        .metricOp  {
            width: 50px;
        }
        .metricAggr  {
            width: 60px;
            margin-right: 10px;
        }
        .metricAction {
            width: 200px;
            margin-right: 10px;
        }
        paper-input#metricValue, 
        paper-input#metricOffset {
            width: 40px;
            display: inline-block;
        }
        paper-input#metricAggr {
            width: 120px;
            display: inline-block;
        }
        .rule.incident-true {
            color: var(--red-color);
        }
        .rule {
            padding: 8px 0;
        }
        .rule-id {
            position: absolute;
            color: rgba(0,0,0,0.32);
            font-size: 0.8em;
            top: 16px;
            left: 24px;
        }
        .rule-actions {
            justify-content: flex-end;
            font-size: 0.9em;
            margin-top: 16px;
        }
        paper-button iron-icon {
            opacity: 0.32;
            padding: 4px;
        }
        .errormsg-container {
            color: var(--red-color);
            align-self: flex-start;
            flex: 1;
        }
        .errormsg-container iron-icon {
            color: inherit;
        }
        paper-input#emails {
            max-width: 240px;
            display: inline-block;
        }
        #newrule > * {
            padding-left: 8px;
            padding-right: 8px;
        }
        paper-dropdown-menu::content #dropdown {
            width: inherit !important;
        }
        .add {
        	cursor: pointer;
        }
	</style>

    <span class="rule-action">        
        
        <paper-dropdown-menu class="dropdown-block metricAction">
            <paper-menu id="metricAction" attr-for-selected="value" selected="{{action.type}}" class="dropdown-content">
                <paper-item value="notification"> send notification </paper-item>
                <paper-item value="machine_action"> execute machine action </paper-item>
                <paper-item value="command"> execute command </paper-item>
            </paper-menu>
        </paper-dropdown-menu>
        
        <template is="dom-if" if="[[_showMachineActions(action.type)]]">
            <paper-dropdown-menu class="dropdown-block">
                <paper-menu id="machineAction" attr-for-selected="value" selected="{{action.action}}" class="dropdown-content">
                    <paper-item value="reboot"> reboot </paper-item>
                    <paper-item value="destroy"> destroy </paper-item>
                </paper-menu>
            </paper-dropdown-menu>
        </template>

        <template is="dom-if" if="[[_showCommand(action.type)]]">
            <paper-textarea id="command" placeholder="command input" value="{{action.command}}"></paper-textarea>
        </template>

        <template is="dom-if" if="[[_showRecipients(action.type)]]">

            to

            <mist-dropdown-multi id="teams" label="teams" selections="[[teams]]" value="{{action.teams}}"></mist-dropdown-multi>

            <mist-dropdown-multi id="members" label="members" selections="[[users]]" value="{{action.users}}"></mist-dropdown-multi>

            <paper-input id="emails" label="other emails" value="{{action.emails}}" auto-validate></paper-input>

        </template>

    </span>

    </template>

    <script>
        Polymer({
            is: 'rule-action',

            properties: {
                action: Object,
                teams: Array,
                users: Array
            },
            observers: [
                '_actionChanged(action)'
            ],
            ready: function(){},
            _showMachineActions: function(action) {
                return this.action.type == 'machine_action';
            },
            _showCommand: function(action){
                return this.action.type == 'command';
            },
            _showRecipients: function(action){
                return this.action.type == 'notification';
            },
            _actionChanged: function(ruleaction) {
                if (this.action.type != 'notification') {
                    this._initDropdowns();
                }
            },
            _initDropdowns: function() {
                this.querySelectorAll('mist-dropdown-multi').forEach(function(el){el.clear()});
            }
        })
    </script>
</dom-module>