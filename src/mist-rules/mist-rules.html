<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">

<link rel="import" href="rules-item.html">
<link rel="import" href="rule-edit.html">

<dom-module id="mist-rules">
    <template>
        <style>
            :host {
                display: block;
            }
            paper-button {
                padding: 0.8em 1.57em 0.7em 1.57em;
                font-weight: 500;
            }
            paper-button[disabled] {
                background-color: rgba(0,0,0,.13) !important;
                color: rgba(0,0,0,0.32) !important;
            }
            paper-material {
                border-top: 2px solid #ddd;
            }
            paper-button iron-icon {
                opacity: 0.32;
                padding: 4px;
            }
            rule-edit {
                padding: 0 24px 16px 24px;
            }
            .rule-actions {
                justify-content: flex-end;
                font-size: 0.9em;
                margin-top: 16px;
            }
            .errormsg-container {
                color: var(--red-color);
                align-self: flex-start;
                flex: 1;
            }
            .errormsg-container iron-icon {
                color: inherit;
            }
        </style>
        <paper-material elevation="0">
            <template is="dom-repeat" items="[[rulesArray]]">
                <rules-item builtin-metrics="[[builtinMetrics]]" custom-metrics="[[customMetrics]]" rule="[[item]]" incidents="[[incidents]]" resource="[[resource]]" model="[[model]]" teams="[[teams]]" users="[[users]]"></rules-item>
            </template>
            
            <paper-button toggles active="{{editNew}}" hidden$="{{editNew}}"><iron-icon icon="icons:add-circle"></iron-icon> add new rule</paper-button>

            <rule-edit  rule={{newRule}}
                        builtin-metrics=[[builtinMetrics]]
                        custom-metrics=[[customMetrics]]
                        available-metrics=[[availableMetrics]]
                        machine=[[machine]]
                        cloud=[[cloud]]
                        resource=[[resource]]
                        form-error=[[formError]]
                        form-message=[[formMessage]]
                        users="[[model.membersArray]]"
                        teams="[[model.teamsArray]]"
                        edit-new="{{editNew}}"
                        hidden$="{{!editNew}}">
                            <div slot="rule-actions" class="rule-actions layout horizontal" hidden$="[[updateExistingRule]]">
                                <p class="errormsg-container" hidden$="[[!formError]]"><iron-icon icon="icons:error-outline"></iron-icon><span id="errormsg">[[formMessage]]</span></p>
                                <paper-spinner active$="{{sendingData}}"></paper-spinner>
                                <paper-button toggles active="{{editNew}}" class="link">cancel</paper-button>
                                <paper-button on-tap="addRule" class="blue" disabled$="[[!isValidRule]]">save rule</paper-button>
                            </div>
                        </rule-edit>

        </paper-material>
        
        <iron-ajax id="addRuleRequest" url="/api/v1/rules" contentType="application/json" handle-as="xml" method="POST" on-request="_handleAddRequest" on-response="_handleAddResponse" on-error="_handleAddError" loading="{{sendingData}}"></iron-ajax>

    </template>

    <script>
        Polymer({
            is: 'mist-rules',

            properties: {
                incidents: {
                    type: Array
                },
                machine: {
                    type: String,
                    value: ''
                },
                cloud: {
                    type: String,
                    value: ''
                },
                resource: Object,  // machine, cloud or other later
                model: Object,
                rules: {
                    type: Object,
                    notify: true
                },
                rulesArray: {
                    type: Array,
                    value: []
                },
                builtinMetrics:{
                    type: Object,
                    notify: true,
                    value: {}
                },
                customMetrics:{
                    type: Object,
                    notify: true,
                    value: {}
                },
                availableMetrics: {
                    type: Array,
                    computed: "_computeMetrics(resource, builtinMetrics, customMetrics)"
                },
                newRule: Object,
                editNew: {
                    type: Boolean,
                    value: false // TODO revert to false 
                },
                formError: {
                    type: Boolean,
                    value: false
                },
                teams: Array,
                users: Array,
                isValieRule: {
                    type: Boolean,
                    value: false,
                    notify: true
                }
            },
            listeners: {
                'iron-select':'userChanges',
                'input':'userChanges',
                'change':'userChanges',
                'edit-request': 'editRequest',
                'add-rule': 'addRule',
                'rule-changed': '_validateRule'
            },
            observers: [
                "_computeRules(rules.*, resource)",
                "_validateRule(newRule.*, newRule.actions.*, newRule.queries.*, newRule.conditions.*)"
            ],
            ready: function() {
                this.init();
            },
            init: function() {
                var new_rule = {
                    actions:[{
                        type: 'notification'
                    }],
                    queries: [{
                        target: 'load.shortterm',
                        operator: 'gt',
                        threshold: 5,
                        aggregation: 'any',
                    }],
                    window: {
                        start: 60,
                        period: 'seconds',
                    },
                    frequency: {
                        every: 60,
                        period: 'seconds',
                    },
                    conditions: [{
                            type: 'machines',
                            ids: ["c770779194034535a4ed7cd259f00847"]
                        }],
                }
                this.set('newRule', new_rule);
            },
            _computeRules: function (rules, resource) {
                var rulesArray = [],
                    thisMachineRules = [],
                    resource = resource,
                    that = this;
                if (this.rules) {
                    for (var rule in this.rules) {
                        rulesArray.push(this.rules[rule]);
                    }
                }
                thisMachineRules = rulesArray.filter(function(r){
                    return that._ruleAppliesOnResource(r,resource);
                }).reverse();
                this.set('rulesArray', thisMachineRules);
            },
            _ruleAppliesOnResource: function (r,resource) {
                var type = 'machines',
                    that = this;
                var m = r.conditions.find(function(c){
                    return c.type == type && c.ids.indexOf(that.resource.id) > -1
                });
                return m ? true : false;
            },
            _computeMetrics: function(resource, builtinMetrics, customMetrics){
                var metrics = [];
                for (var p in this.builtinMetrics){
                    metrics.push(this.builtinMetrics[p])
                }
                if (this.customMetrics) {
                    for (var q in this.customMetrics){
                        if (this.customMetrics[q].machines) {
                            var machineHasCustomMetric = this.customMetrics[q].machines.find(function(m){
                                return m[0] == this.resource.cloud.id && m[1] == this.resource.machine_id;
                            }, this);
                            if (machineHasCustomMetric)
                                metrics.push(this.customMetrics[q])
                        }
                    }
                }
                return metrics;
            },
            addRule: function(e){
                var payload = this.newRule;
                payload.window.start = parseInt(payload.window.start);
                payload['frequency']['every'] = payload.window.start;
                payload['frequency']['period'] = payload.window.period;
                // emails should be sent as Arrays
                for (var i=0; i<payload.actions.length; i++){
                    if (payload.actions[i].type == 'notification' &&
                        payload.actions[i].emails &&
                        payload.actions[i].emails.length &&
                        typeof(payload.actions[i].emails) == "string"){
                        var emails = payload.actions[i].emails.split(',');
                            for (var j=0; j<emails.length; j++){
                                emails[j] = emails[j].trim();
                            }
                        payload.actions[i].emails = emails;
                    }
                }
                this.$.addRuleRequest.body = payload;
                this.$.addRuleRequest.headers["Content-Type"] = 'application/json';
                this.$.addRuleRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.addRuleRequest.generateRequest();
            },
            _handleAddResponse: function(){
                this.set('editNew', false);
                this.set('formError', false);
                this.init();
            },
            _handleAddError: function(e){
                console.log(e.detail.request.xhr.responseText);
                this.set('formMessage',e.detail.request.xhr.responseText)
                this.set('formError', true);
            },
            userChanges: function(){
                this._validateRule();
                this.set('formError', false);
            },
            editRequest: function(e){
                // handling of edit area
                var id = e.detail.rule;
                var els = this.querySelectorAll('rules-item');
                [].forEach.call(els, function(el, index) {
                    if (el.rule.id != id) {
                        el.set('editMode', false);
                    }
                });
            },
            _validateRule: function(rule, actions, queries, conditions) {
                console.log('validate rule');
                var valid = true,
                    validActions = true, 
                    validQueries = true,
                    validConditions = true; 
                for (var p in this.newRule) {
                    console.log(p);
                    if (this.newRule[p] == undefined){
                        valid = false;
                        break;
                    }
                }
                for (var i=0; i<this.newRule.actions.length; i++) {
                    validActions = this._validateActions(this.newRule.actions[i]);
                    console.log(validActions, this.newRule.actions[i].type);
                    if (!validActions)
                        break;
                }
                for (var i=0; i<this.newRule.queries.length; i++) {
                    validQueries = this._validateQueries(this.newRule.queries[i]);
                    console.log(validQueries, this.newRule.queries[i]);
                    if (!validQueries)
                        break;
                }
                for (var i=0; i<this.newRule.conditions.length; i++) {
                    validConditions = this._validateConditions(this.newRule.conditions[i]);
                    console.log(validConditions, this.newRule.conditions[i].type);
                    if (!validConditions)
                        break;
                }
                this.set('isValidRule', valid & validActions && validQueries && validConditions);
            },
            _validateActions: function(action) {
                var valid = true;
                if (action.type == ''){
                    valid = false;
                }

                if (action.type == 'machine_action')
                    if (!action.action || !action.action.length){
                        valid = false;
                    }

                if (action.type == 'notification')
                    if ((!action.emails || !action.emails.length) && 
                        (!action.teams || !action.teams.length) && 
                        (!action.users || !action.users.length)){
                        valid = false;
                    }

                if (action.type == 'command')
                    if (!action.command || !action.command.length){
                        valid = false;
                    }
                return valid;
            },
            _validateQueries: function(query) {
                var valid = true;
                if (!query.target || !query.operator || !query.threshold || !query.aggregation)
                    valid = false
                return valid;
            },
            _validateConditions: function(condition) {
                var valid = true;
                if (!condition.type || !condition.ids || !condition.ids.length)
                    valid = false;
                return valid;
            },
        });
    </script>
</dom-module>
