<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<dom-module id="firmware-update">
    <template>
        <style include="shared-styles dialogs">
         :host {
            display: block;
            width: 100%;
        }

        paper-dialog {
            min-width: 360px;
        }

         :host .btn-group {
            margin: 0 0 24px 0;
        }

        .title {
            text-transform: capitalize;
        }

        .grey {
            opacity: 0.54;
        }

        .progress {
            margin: 24px -24px 24px -24px;
            width: 100%;
        }

        .progress paper-progress {
            width: 100%;
        }

        paper-progress.progresserror ::content #primaryProgress {
            background-color: var(--red-color);
        }

        .error {
            color: var(--red-color);
            align-self: flex-end;
            padding: 8px;
            font-size: 0.9em;
        }

        iron-icon {
            color: inherit;
        }

        .errormsg-container {
            color: var(--red-color);
            padding-left: 24px;
            padding-right: 24px;
            margin-bottom: 0;
        }

        .errormsg-container iron-icon {
            color: inherit;
            padding-right: 8px;
        }

        p.red {
            padding: 4px;
            margin-top: 0;
        }

         :host paper-dropdown-menu ::content .dropdown-content {
            top: 55px !important;
        }
        paper-radio-button {
            width: 90%;
        }
        paper-checkbox {
           --paper-checkbox-checked-color: var(--mist-blue) !important;
           --paper-checkbox-checked-ink-color: var(--mist-blue) !important;
        }
        </style>
        <paper-dialog id="firmwareDialogModal" entry-animation="scale-up-animation" exit-animation="fade-out-animation" with-backdrop>
            <h2 class="title">[[action.name]]</h2>
            <paper-dialog-scrollable>
                <!-- isUpdate -->
                <template is="dom-if" if="[[isUpdate]]">
                    <p hidden="[[!firmwareList.length]]">Choose from available firmwares.</p>
                    <paper-radio-group selected="{{firmware}}" hidden="[[!firmwareList.length]]">
                        <template is="dom-repeat" items="[[firmwareList]]">
                            <paper-radio-button name="[[item.firmware_id]]">[[item.key]] <br/>([[item.size]])</paper-radio-button>
                        </template>
                    </paper-radio-group>
                    <p hidden="[[firmwareList.length]]">No available firmwares found.</p>
                </template>
                <!-- isDelete -->
                <template is="dom-if" if="[[isDelete]]">
                    <p hidden="[[!firmwareList.length]]">Choose firmwares to delete.</p>
                    <paper-radio-group selected="{{firmwareToDelete}}" hidden="[[!firmwareList.length]]">
                        <template is="dom-repeat" items="[[firmwareList]]">
                            <paper-radio-button name="[[item.firmware_id]]">[[item.key]] <br/>([[item.size]])</paper-radio-button>
                        </template>
                    </paper-radio-group>
                    <p hidden="[[firmwareList.length]]">No available firmwares found.</p>
                </template>
                <!-- isBackup -->
                <template is="dom-if" if="[[isBackup]]">
                    <p>A copy of the current firmware will be saved. It will then be available in the machines firmware list.</p>
                </template>
                <!-- isUpload -->
                <template is="dom-if" if="[[isUpload]]">
                    <p>Upload a firmware from your computer.</p>
                    <vaadin-upload id="firmwareUpload" max-files="1" accept=".zip"
                        headers="[[_computeUploadHeaders()]]"
                        target$="/api/v1/machines/[[machine.id]]"
                        on-upload-request="_handleUploadRequest"
                        form-data-name="firmware_zip"
                        method="POST">
                        <div class="drop-label">
                            <iron-icon icon="file-upload"></iron-icon>
                            Drop file here.
                        </div>
                        <div class="file-container">
                        </div>
                    </vaadin-upload>
                </template>
            </paper-dialog-scrollable>
            <div class="progress">
                <paper-progress id="progress" indeterminate hidden$="[[!loading]]"></paper-progress>
                <paper-progress id="progresserror" class="progresserror" value="100" hidden$="[[!formError]]"></paper-progress>
                <p id="progressmessage" class="errormsg-container" hidden$="[[!formError]]"><iron-icon icon="icons:error-outline"></iron-icon><span id="errormsg"></span></p>
            </div>
            <div class="clearfix btn-group">
                <paper-button dialog-dismiss>
                    Cancel
                </paper-button>
                <paper-button class$="[[_getClass(action)]]" on-tap="firmwareUpdate" disabled="[[!_enableButton(action, firmware, firmwareToDelete, isBackup, isUpload)]]">
                    [[action.name]]
                </paper-button>
            </div>
        </paper-dialog>
        <iron-ajax id="firmwareUpdateRequest" method="POST" on-response="_firmwareUpdateResponse" on-error="_firmwareUpdateError" on-request="_firmwareUpdateRequest" handle-as="xml" loading="{{loading}}"></iron-ajax>
    </template>
</dom-module>
<script>
Polymer({
    is: 'firmware-update',
    properties: {
        machine: {
            type: Object
        },
        action: {
            type: Object
        },
        isUpdate: {
            type: Boolean,
            value: false,
            computed: '_computeisUpdate(action)'
        },
        isUpload: {
            type: Boolean,
            value: false,
            computed: '_computeIsUpload(action)'
        },
        isBackup: {
            type: Boolean,
            value: false,
            computed: '_computeIsBackup(action)'
        },
        isDelete: {
            type: Boolean,
            value: false,
            computed: '_computeIsDelete(action)'
        },
        loading: {
            type: Boolean,
            value: false
        },
        firmwareList: {
            type: Array,
            value: []
        },
        formError: {
            type: Boolean,
            value: false
        },
        firmware: {
            type: String,
            value: ''       
        },
        file: {
            type: String,
            value: ''
        },
        firmwareToDelete: {
            type: String,
            value: ''
        }
    },
    observers: [
        '_firmwareListChanged(firmwareList)'
    ],
    ready: function () {},
    _handleUploadRequest: function (event) {
        event.detail.formData.append('action', 'upload_firmware');
    },
    _firmwareListChanged: function(list) {
        this.$.firmwareDialogModal.refit();
    },
    _getClass: function(action){
        return this.action.name == 'delete firmware' ? 'red' : 'blue';
    },
    _computeisUpdate: function(action) {
        return action.name == 'update firmware';
    },
    _computeIsUpload: function(action) {
        return action.name == 'upload firmware';
    },
    _computeIsBackup: function(action) {
        return action.name == 'backup current firmware';
    },
    _computeIsDelete: function(action) {
        return action.name == 'delete firmware';
    },
    _openDialog: function(e) {
        this.clearError();
        this.set('selectedType', '');
        this.$.firmwareDialogModal.open();
    },
    _closeDialog: function(e) {
        this.$.firmwareDialogModal.close();
        this.clearError();
    },
    firmwareUpdate: function(e) {
        var request = this.$.firmwareUpdateRequest;
        request.url = "/api/v1/machines/" + this.machine.id;
        if (this.isUpdate) {
            request.body = {action: 'put_firmware', firmware_id: this.firmware};
        }
        if (this.isUpload) {
            request.body = {action: 'upload_firmware', firmware: this.file};
        }
        if (this.isBackup) {
            request.body = {action: 'backup_firmware'};
        }
        if (this.isDelete) {
            request.body = {action: 'delete_firmware', firmware_id: this.firmwareToDelete};
        }
        request.headers["Content-Type"] = 'application/json';
        request.headers["Csrf-Token"] = CSRF_TOKEN;
        request.generateRequest();
    },
    _firmwareUpdateRequest: function() {
        this.clearError();
        var logMessage = 'Sending request.';
        this.fire('performing-action', { log: logMessage });
    },
    _firmwareUpdateResponse: function(e) {
        console.log(e, e.detail);
        this._closeDialog();
        this.fire('action-finished', { success: true });
        this.fire('toast', { msg: 'Firmware update request sent successfully. Review in machine logs.', duration: 5000 });
    },
    _firmwareUpdateError: function(e) {
        console.log(e, e.detail);
        var message = e.detail.request.xhr.response || e.detail.error.message;
        this.$.errormsg.textContent = message;
        this.set('formError', true);
        this.fire('action-finished', { success: false });
    },
    clearError: function(){
        this.set('formError', false);
        this.$.errormsg.textContent = '';
        this.$.firmwareDialogModal.refit();
    },
    _computeUploadHeaders: function() {
        return {'Csrf-Token': CSRF_TOKEN, 'Accept': 'application/json'};
    },
    _enableButton: function(action, firmware, firmwareToDelete, isBackup, isUpload) {
        if (this.isUpdate) {
            return this.firmware ? true : false;
        }
        if (this.isUpload) {
            return this.file.length;   
        }
        if (this.isBackup) {
            return true;
        }
        if (this.isDelete) {
            return this.firmwareToDelete ? true : false;
        }
        return false;
    }
});
</script>