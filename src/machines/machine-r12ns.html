<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">

<script type="text/javascript" src="../../bower_components/moment/moment.js" inline></script>

<dom-module id="machine-r12ns">
    <template>
        <style is="custom-style" include="tags-and-labels"></style>
        <style is="custom-style" include="info-table-style"></style>
        <style is="custom-style" include="single-page"></style>
        <style include="shared-styles">

            div.r12n {
                overflow: visible;
                height: 44px;
                font-size: 16px;
                line-height: 1.4em;
                border-top: 1px solid #ddd;
            }

            div.r12n:first-of-type {
                border-top: none;
            }

            div.r12n a {
                color: #2196F3 !important;
                font-weight: 400;
                font-size: 0.9em;
            }

            div.info-card {
                margin: 0;
            }

            div.card-content {
                padding: 18px 24px;
            }

            paper-material {
                padding: 24px;
                box-sizing: border-box;
                width: 100%;
            }

            .r12n-icon {
                float: left;
                padding: 8px 15px 8px 0;
            }

            .description {
                float: left;
                width: 70%;
                vertical-align: center;
            }

            .recommended .customize {
                margin-left: 10px;
            }

            .actions {
                float: right;
                wdith: 30%;
            }

            paper-button.apply {
                background-color: #2196F3;
                color: white;
                --paper-button-raised-keyboard-focus: {
                  background-color: var(--paper-pink-a200) !important;
                  color: white !important;
                };
            }

            paper-button.dismiss {
                background-color: #eee;
                color: #777;
            }

        </style>

        <!--template is="dom-if" if="[[hasScaleR12n]]"-->
        <div class="info-card" style="background-color: #8c76d1;">
            <h2 style="color:#fff; margin: 4px;">Recommendations</h2>
        </div>
        <div class="card-content">
            <template is="dom-repeat" items="[[model.notificationsArray]]" as="notification" hidden$="{{!hasScaleR12n}}">
                <div class="r12n" notification-id$="[[notification._id]]">
                <iron-icon class="r12n-icon" slot="item-icon" icon="[[_computeR12nIcon(notification)]]"></iron-icon>
                    <div class="description">
                        <span inner-h-t-m-l="{{notification.html_body}}"></span>
                    </div>
                    <div class="actions">
                        <paper-button on-tap="_resizeTap" class="apply" raised>Resize...</paper-button>
                        <paper-button on-tap="_dismiss" class="dismiss" notification-id$="[[notification._id]]">Dismiss</paper-button>
                    </div>
                </div>
            </template>
        </div>
        <!--/template-->

        <iron-ajax
            id="requestDismiss"
            url="/api/v1/notifications/"
            method="DELETE"
            handle-as="json"
            on-response="handleDismissResponse">
        </iron-ajax>

    </template>
    <script>
        Polymer({
            is: 'machine-r12ns',
            properties: {
                model: {
                    type: Object
                },
                machine: {
                    type: String
                },
                hasScaleR12n: {
                    type: Boolean,
                    computed: '_hasScaleR12n(model.notificationsArray, machine)'
                }
            },
            _hasScaleR12n: function(notifications, machine) {
                for (i=0; i<notifications.length; i++)
                {
                    var notification = notifications[i]
                    if (notification.resource && notification.resource._ref.$id == machine)
                    {
                        return true;
                    }
                }
                return false;
            },
            _computeR12nIcon: function(notification) {
                if (notification.kind == "r12n.machine.scale.up") {
                    return "icons:arrow-upward";
                }
                else if (notification.kind == "r12n.machine.scale.down") {
                    return "icons:arrow-downward";
                }
            },
            _resizeTap: function(e) {
                var action = {
                    'name': 'resize',
                    'icon': 'device:signal-cellular-2-bar',
                    'confirm': true,
                    'multi': false
                }
                this.fire('select-action',{action: action})
                // TODO: dismiss notification on success?
            },
            _dismiss: function(e) {
                var notificationID = event.srcElement.getAttribute("notification-id");
                var dismissURL = "/api/v1/notifications/" + notificationID;
                this.$.requestDismiss.url = dismissURL;
                this.$.requestDismiss.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.requestDismiss.generateRequest();
                event.stopPropagation();
            },
            handleDismissResponse: function(event) {
                var obj = JSON.parse(event.detail.__data__.response);
                var id = obj._id;
                for (i=0; i<this.model.notificationsArray.length; ++i) 
                {
                    var notification = this.model.notificationsArray[i];
                    if (notification._id == id)
                    {
                        this.fire('dismiss-notification', i)
                        return;
                    }
                }
            }
        });
    </script>
</dom-module>