<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/vaadin-dialog/vaadin-dialog.html">
<link rel="import" href="../../bower_components/mist-list/mist-list-actions-behavior.html">

<dom-module id="machine-expiration-edit">
    <template>
        <style include="shared-styles dialogs">
        :host {
            width: 100%;
        }

        .paper-dialog-scrollable {
            padding-bottom: 24px;
        }

        .collapsible {
            height: 0;
            overflow: hidden;
            transition: height 300ms ease-in-out 100ms;
        }

        .collapsible[open] {
            height: auto;
        }

        @media screen and (max-width: 450px) {
            :host paper-dropdown-menu ::slotted(.dropdown-content) {
                top: 0 !important;
            }
        }
        </style>
        <vaadin-dialog id="dialogModal" theme="mist-dialog" with-backdrop>
            <template>
                <h2>Edit expiration date</h2>
                <div class="paper-dialog-scrollable">
                    <app-form fields="{{fields}}" single-column inline show-cancel btncontent="Save" url="api/v1/machines/[[machine.id]]" method="PUT" format-payload></app-form>
                </div>
            </template>
        </vaadin-dialog>
    </template>
    <script>
    Polymer({
        is: 'machine-expiration-edit',

        properties: {
            model: {
                type: Object
            },
            machine: {
                type: Object
            },
            fields: {
                type: Array,
                value: function () {
                    return [
                    {
                        name: 'expiration',
                        label: 'Expiration Date',
                        type: 'fieldgroup',
                        value: {},
                        defaultValue: {},
                        defaultToggleValue: true,
                        show: true,
                        required: false,
                        optional: true,
                        subfields: [
                            {
                                name: 'action',
                                label: 'Expiration action',
                                type: 'dropdown',
                                class: 'bind-both',
                                value: 'stop',
                                defaultValue: 'stop',
                                helptext: '',
                                show: true,
                                required: false,
                                class: 'width-150 inline-block',
                                options: [
                                    {val: 'stop', title: 'STOP'},
                                    {val: 'destroy', title: 'DESTROY'}
                                ]
                            }, {
                                name: 'date',
                                type: 'duration_field',
                                label: 'Expire after',
                                class: 'bind-both',
                                value: '',
                                defaultValue: '',
                                valueType: 'date',
                                valueDefaultSpan: 1,
                                valueDefaultUnit: 'days',
                                helptext: '',
                                show: true,
                                required: false,
                                prefixText: 'in ',
                                options: [
                                    {val: 'months', title: 'months'},
                                    {val: 'weeks', title: 'weeks'}, 
                                    {val: 'days', title: 'days'},
                                    {val: 'hours', title: 'hours'}
                                ]
                            }, {
                                name: 'notify',
                                type: 'duration_field',
                                label: 'Notify me before',
                                valueType: 'secs',
                                value: 3600,
                                defaultValue: 3600,
                                valueDefaultSpan: 1,
                                valueDefaultUnit: 'hours',
                                class: 'bind-both',
                                helptext: '',
                                show: true,
                                required: false,
                                prefixText: 'Notify me ',
                                suffixText: 'before',
                                smallfont: true,
                                optional: true,
                                options: [
                                    {val: 'months', title: 'months'},
                                    {val: 'weeks', title: 'weeks'}, 
                                    {val: 'days', title: 'days'},
                                    {val: 'hours', title: 'hours'},
                                    {val: 'minutes', title: 'minutes'}
                                ]
                            }
                        ]
                    }
                    ]
                }
            }
        },
        listeners: {
            'change': 'updateInputs',
            'format-payload': 'formatPayload'
            // 'open-and-select' : 'openAndSelect'
        },
        attached: function() {
            
        },
        _openDialog: function(e) {
            this._initialiseValues();
            this.$.dialogModal.opened = true;
        },
        _closeDialog: function(e) {
            this.$.dialogModal.opened = false;
        },
        _initialiseValues: function() {
            var date = this.machine.expiration_date, 
                fromNow = this._dateToDurationFromNow(date);
            var notify = this.machine.expiration_notify,
                before = this._secondsToDuration(notify);
            this.set('field.0.subfields.0.valueDefaultSpan', fromNow.span); //date to duration
            this.set('field.0.subfields.0.valueDefaultUnit', fromNow.unit); //date to duration
            this.set('field.0.subfields.1.value', this.machine.expiration_action);
            this.set('field.0.subfields.2.valueDefaultSpan', before.span);
            this.set('field.0.subfields.2.valueDefaultUnit', before.unit); 
        },
        _dateToDurationFromNow: function(date) {
            var fromNow = moment(date).fromNow(true);
            var chunks = fromNow.split(' ');
            var span = chunks[0]
            var unit = chunks[1];
            return {span: span, unit: unit}
        },
        _secondsToDuration: function(seconds) {
            var step, span;
            if (seconds%(3600*24*7) == 0) {
                step = 'weeks';
                span = seconds/(3600*24*7);
            } else if (seconds%(3600*24) == 0) {
                step = 'days';
                span = seconds/(3600*24);
            } else if (seconds%3600 == 0) {
                step = 'hours';
                span = seconds/3600;
            } else if (seconds%60 == 0) {
                step = 'minutes';
                span = seconds;
            }
            return {span: span, unit: step}
        }
    });
    </script>
</dom-module>