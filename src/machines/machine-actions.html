<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-error.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/vaadin-icons/vaadin-icons.html">

<link rel="import" href="../mist-actions.html">

<dom-module id="machine-actions">
  <template>
    <style include="shared-styles">
      :host {
        display: inline-block;
        color: rgba(255,255,255,0.87);
      }
    </style>
    
    <mist-actions actions="[[actions]]" type="machines" items="[[items]]"></mist-actions>

    <dialog-element id="confirm"></dialog-element>

    <iron-ajax id="request"
            handle-as="json"
            loading="{{loadingData}}"
            on-response="handleResponse"
            on-error="handleError"></iron-ajax>

  </template>
  <script>
MACHINE_ACTIONS = {
  'shell': {
    'name': 'shell',
    'icon': 'vaadin-icons:terminal',
    'confirm': false,
    'multi': true
  },
  'tag': {
    'name': 'tag',
    'icon': 'label',
    'confirm': true,
    'multi': true
  },
  'associate-key': {
    'name': 'associate key',
    'icon': 'communication:vpn-key',
    'confirm': true,
    'multi': true
  },
  'run-script': {
    'name': 'run script',
    'icon': 'image:movie-creation',
    'confirm': true,
    'multi': false
  },
  'reboot': {
    'name': 'reboot',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'start': {
    'name': 'start',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'stop': {
    'name': 'stop',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'suspend': {
    'name': 'suspend',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'rename': {
    'name': 'rename',
    'icon': 'editor:mode-edit',
    'confirm': true,
    'multi': false
  },
  'resume': {
    'name': 'resume',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'undefine': {
    'name': 'undefine',
    'icon': 'image:panorama-fish-eye',
    'confirm': true,
    'multi': true
  },
  'destroy': {
    'name': 'destroy',
    'icon': 'delete',
    'confirm': true,
    'multi': true
  },
  'tag': {
    'name': 'tag',
    'icon': 'label',
    'confirm': true,
    'multi': true
  },
  'delete': {
    'name': 'delete',
    'icon': 'delete',
    'confirm': true,
    'multi': true
  }
}
    Polymer({ 
      is: 'machine-actions',
      properties: {
        items: { 
          type: Array,
          value: []
        },
        actions: { 
          type: Array,
          value: []
        }
      },
      observers:[
        '_mapPolicyToActions(items.*)'
      ],
      listeners: {
        'perform-action': 'performAction'
      },
      ready: function() {},
      attached: function() {
        this.$.request.headers["Content-Type"] = 'application/json';
        this.$.request.headers["Csrf-Token"] = CSRF_TOKEN;
        this.$.request.method = "POST";
      },
      itemActions: function(machine) {
        var arr = [];
        if (machine) {
          arr.push('shell');
        }
        if (machine && machine.actions) {
          for (var action in machine.actions) {
            if (machine.actions[action])
              arr.push(action);
          }
        }
        if (machine) {
          arr.push('tag');
        }
        return arr;
      },
      actionDetails: function (actions) {
        var ret = [];
        for (var i=0; i<actions.length; i++) {
            ret.push(MACHINE_ACTIONS[actions[i]]);
        }
        return ret;
      },
      _delete: function() {
        //set up iron ajax
        this.$.request.headers["Content-Type"] = 'application/json';
        this.$.request.headers["Csrf-Token"] = CSRF_TOKEN;
        this.$.request.method = "DELETE";

        for (var i = 0; i < this.items.length; i++) {
          this.$.request.url = "/api/v1/machines/"+ this.items[i].id
          this.$.request.generateRequest();
          this.fire('toast', {msg: 'Deleting ' + this.items[i].name , duration: 1000})
        }
      },
      _showDialog: function(info) {
          var dialog = this.querySelector('dialog-element');
          for (var i in info) {
              dialog[i] = info[i];
          }
          dialog._openDialog();
      },
      performAction: function(e) {
        // console.log('performAction', e.detail.action);
        var action = e.detail.action;
        if (action.name == 'delete') {
          this._delete();
        }
      },
      handleResponse: function(e) {
        if (this.$.request && this.$.request.body && this.$.request.body.action)
          this.fire('toast', {msg: 'Action: '+this.$.request.body.action+' successfull', duration: 3000})
      },
      _mapPolicyToActions: function (items) {
        // recompute the actions array property as the intersection
        // of the available actions of the selected items
        this.set('actions', []);
        var actions = new swiftSet.Set(), 
            isection = new swiftSet.Set();

        if (this.items.length > 0) {
          actions.addItems(this.itemActions(this.items[0]) || []);

          for (var i=1; i<this.items.length; i++) {
              isection.clear()
              isection.addItems(actions.intersection(this.itemActions(this.items[i])));
              actions.clear();
              actions.addItems(isection.items());
          }

          var multiActions;

          if (this.items.length > 1) {
              multiActions = this.actionDetails(actions.items()).filter(function(a){
                  return a.multi;
              });
          }
          else {
              multiActions = this.actionDetails(actions.items());
          }
        }
        this.set('actions', multiActions);
      },

      handleError: function(e) {
        // console.log(e.detail.request.xhr.statusText);
        this.fire('toast', {msg: 'Error: ' + e.detail.request.xhr.status +" "+ e.detail.request.xhr.statusText, duration: 5000});
      }
    });
  </script>
</dom-module>