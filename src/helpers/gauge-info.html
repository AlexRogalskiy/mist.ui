<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">

<script src='../../bower_components/moment/min/moment.min.js'></script>
<script src='../../bower_components/timerange-picker/relative.time.parser.js'></script>

<script src='../../bower_components/echarts/dist/echarts.min.js'></script>
<!-- <script src="../../bower_components/view-json/view-json.js"></script> -->

<dom-module id="gauge-info">
    <template>
        <style include="shared-styles tags-and-labels">
            :host {
                display: inline-block;
                width: 32%;
                height: 355px;
                vertical-align: top;
                position: relative;
                overflow: hidden;
            }

            .title {
                line-height: 1.6;
            }

            .text-center {
                text-align: center;
            }

            .tag {
                display: inline;
                line-height: 1.6em;
                padding: 4px 8px;
                margin-right: 8px;
            }
            .green {
                background-color: var(--green-color);
                color: #fff;
            }

            .red {
                background-color: var(--red-color);
                color: #fff;
            }

            .orange {
                background-color: var(--orange-color);
                color: #444;
            }

            #gaugeInfo {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                overflow-y: scroll;
            }

            #gaugeInfo view-json {

            }

            paper-icon-button.toggle {
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1;
                opacity: 0.54;
            }

            .absent-true {
                opacity: 0.3;
            }
        </style>

        <h2 class="title text-center">
            <strong>[[data.Name]]</strong> <br/>
            <span class="tag" hidden="[[!isAbsent]]">[[data.Status.State]]</span>
            <span class$="tag [[_class(data)]]" hidden="[[isAbsent]]">Health: [[data.Status.Health]]</span>
        </h2>

        <paper-icon-button icon="icons:visibility" class="toggle" on-tap="toggleData"></paper-icon-button>
        
        <div id="gauge" class$="absent-[[isAbsent]]" style="width:280px; height:280px; margin: 0 auto;"></div>

        <div id="gaugeInfo" hidden="[[!dataOpen]]">
            <view-json>[[_stringify(data)]]</view-json>
        </div>

    </template>
    <script>
    GAUGE_INFO_OPTIONS = {
        tooltip: {
            formatter:  "{a} <br/>{b} : {c}"
        },
        toolbox: {
            show: true,
            feature: {
                saveAsImage: {
                    show: false
                }
            },
        },
        series:  [
            {
                name:'fan/temperature',
                type:'gauge',
                detail : {formatter:'{value}'},
                center: ['50%', '39%'],
                data:[{value: 50, name: 'data ena'}]
            }
        ]
    };
    GRAY_GAUGE_THEME = {
        color: [
            '#757575','#c7c7c7','#dadada',
            '#8b8b8b','#b5b5b5','#e9e9e9'
        ],
        title: {
            textStyle: {
                fontWeight: 'normal',
                color: '#757575'
            }
        },
        dataRange: {
            color:['#636363','#dcdcdc']
        },
        toolbox: {
            color : ['#757575','#757575','#757575','#757575']
        },
        tooltip: {
            backgroundColor: 'rgba(0,0,0,0.5)',
            axisPointer : {
                type : 'line',
                lineStyle : {
                    color: '#757575',
                    type: 'dashed'
                },
                crossStyle: {
                    color: '#757575'
                },
                shadowStyle : {
                    color: 'rgba(200,200,200,0.3)'
                }
            }
        },
        dataZoom: {
            dataBackgroundColor: '#eee',
            fillerColor: 'rgba(117,117,117,0.2)',
            handleColor: '#757575'
        },
        grid: {
            borderWidth: 0
        },
        categoryAxis: {
            axisLine: {
                lineStyle: {
                    color: '#757575'
                }
            },
            splitLine: {
                lineStyle: {
                    color: ['#eee']
                }
            }
        },
        valueAxis: {
            axisLine: {
                lineStyle: {
                    color: '#757575'
                }
            },
            splitArea : {
                show : true,
                areaStyle : {
                    color: ['rgba(250,250,250,0.1)','rgba(200,200,200,0.1)']
                }
            },
            splitLine: {
                lineStyle: {color: ['#eee']}
            }
        },
        timeline : {
            lineStyle : {
                color : '#757575'
            },
            controlStyle : {
                normal : { color : '#757575'},
                emphasis : { color : '#757575'}
            }
        },
        k: {
            itemStyle: {
                normal: {
                    color: '#8b8b8b',
                    color0: '#dadada',
                    lineStyle: {
                        width: 1,
                        color: '#757575',
                        color0: '#c7c7c7'
                    }
                }
            }
        },
        map: {
            itemStyle: {
                normal: {
                    areaStyle: {
                        color: '#ddd'
                    },
                    label: {
                        textStyle: {
                            color: '#c12e34'
                        }
                    }
                },
                emphasis: {
                    areaStyle: {
                        color: '#99d2dd'
                    },
                    label: {
                        textStyle: {
                            color: '#c12e34'
                        }
                    }
                }
            }
        },
        force : {
            itemStyle: {
                normal: {
                    linkStyle : {
                        color : '#757575'
                    }
                }
            }
        },
        chord : {
            padding : 4,
            itemStyle : {
                normal : {
                    borderWidth: 1,
                    borderColor: 'rgba(128, 128, 128, 0.5)',
                    chordStyle : {
                        lineStyle : {
                            color : 'rgba(128, 128, 128, 0.5)'
                        }
                    }
                },
                emphasis : {
                    borderWidth: 1,
                    borderColor: 'rgba(128, 128, 128, 0.5)',
                    chordStyle : {
                        lineStyle : {
                            color : 'rgba(128, 128, 128, 0.5)'
                        }
                    }
                }
            }
        },
        gauge : {
            axisLine: {
                show: true,
                lineStyle: {
                    color: [[0.2, '#b5b5b5'],[0.8, '#757575'],[1, '#5c5c5c']], 
                    width: 8
                }
            },
            axisTick: {
                splitNumber: 10,
                length :12,
                lineStyle: {color: 'auto'}
            },
            axisLabel: {
                textStyle: {color: 'auto'}
            },
            splitLine: {
                length : 18,
                lineStyle: {color: 'auto'}
            },
            pointer : {
                length : '90%',
                color : 'auto'
            },
            title : {
                textStyle: {color: '#333'}
            },
            detail : {
                textStyle: {color: 'auto'}
            }
        }
    };
    
    Polymer({
        is: 'gauge-info',
        properties: {
            data: {
                type: Object
            },
            type: {
                type: String
            },
            gauge: {
                type: Object
            },
            gaugeOptions: {
                type: Object,
                value: function(){
                    return GAUGE_INFO_OPTIONS;
                }
            },
            isAbsent: {
                type: Boolean,
                computed: '_computedIsAbsent(data.Status.State)'
            },
            gaugeWidth: {
                type: Number,
                value: 200
            },
            dataOpen: {
                type: Boolean,
                value: false
            }
        },
        observers: [
            '_dataChanged(data.*)'
        ],
        attached: function(){
            
        },
        detach: function(){
            echarts.dispose(this.gauge);
            console.debug('dashboard detached');
        },
        _computedIsAbsent: function(state) {
            return this.data && this.data.Status.State == "Absent";
        },
        initCharts: function(theme) {
            var grayTheme = GRAY_GAUGE_THEME; 
            echarts.registerTheme('gray', grayTheme);
            if (!theme) {
                var theme = "default";
            }
            this.gauge = echarts.init(this.$.gauge, theme);
            this.gauge.setOption(this.gaugeOptions);
            // this.updateChartWidth();
            console.log('initialized charts');
        },
        updateChartWidth: function() {
            var parentWidth = this.parentNode.offsetWidth;
            console.log('updateChartWidth', parentWidth);
            if (parentWidth) {
                this.set('gaugeWidth', parentWidth);
                this.resizeGraph();
            }
        },
        _dataChanged: function(data) {
            var series = [{}],
                tooltip = {}
            if (this.type == "temperature") {
                series = [{
                    name:this.type,
                    type:'gauge',
                    detail : {formatter:'{value}℃'},
                    center: ['50%', '39%'],
                    data: [{value: this.data.ReadingCelsius, name:this.data.PhysicalContext}],
                    max: this.data.UpperThresholdFatal || this.data.UpperThresholdCritical || '100'
                }];
                tooltip = {formatter:  "{a} <br/>{b} : {c}℃"}
            } else if (this.type == "fan") { 
                series = [{
                    name:this.type,
                    type:'gauge',
                    detail : {formatter:'{value}%'},
                    center: ['50%', '39%'],
                    data: [{value: this.data.Reading, name:''}],
                    max: '100'
                }];
                tooltip = {formatter:  "{a} <br/>{b} : {c}%"}
            } else if (this.type == "power") {
                series = [{
                    name:this.type,
                    type:'gauge',
                    detail : {formatter:'{value}Watt'},
                    center: ['50%', '39%'],
                    data: [{value: this.data.LastPowerOutputWatts || 0, name:''}],
                    max: this.data.PowerCapacityWatts || 500
                }];
                tooltip = {formatter:  "{a} <br/>{b} : {c}Watt"}
            }

            this.set('gaugeOptions.series', series);
            this.set('gaugeOptions.tooltip', tooltip);

            if (this.gauge && this.gauge.id) {
                this.gauge.setOption(this.gaugeOptions, true, true);
            } else {
                if (this.data.Status.State == "Absent") {
                    this.initCharts('gray');
                } else {
                    this.initCharts();
                }
            }
            
        },
        _class: function(data) {
            if (this.data.Status.Health == "OK") {
                return "green";
            } else if (this.data.Status.Health == "Warning") {
                return "orange";
            } else if (this.data.Status.State == "Absent") {
                return "";
            } else {
                return "";
            }
        },
        _stringify: function(data) {
            return JSON.stringify(this.data);
        },
        toggleData: function() {
            this.set('dataOpen', !this.dataOpen);
        }
    });
    </script>
</dom-module>