<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="port-item.html">
<dom-module id="mist-ports-field">
    <template>
        <style include="shared-styles dialogs">
        :host {
            padding: 0;
            margin: 0;
            display: block;
        }

        .port-list {
            padding: 0 0 24px 0;
        }

        :host .port-list>p {
            margin: 24px 0 0 0;
        }

        .submit-btn.add {
            margin: 0 0 0 -14px;
        }

        iron-icon {
            color: inherit !important;
        }

        paper-button.keyboard-focus {
            font-weight: bold !important;
        }

        .title {
            text-transform: capitalize;
            font-weight: bold;
        }
        .helptext, .helptext code {
            font-size: .9em;
        }
        code {
            background-color: rgba(0,0,0,0.05);
            border-radius: 2px;
            padding: 1px 2px;
        }
        </style>
        <div class="title">[[field.label]]</div>
        <p class="helptext">[[field.helptext]]</p>
        <div class="port-list">
            <template id="ports" is="dom-repeat" items="[[ports]]" as="port">
                <port-item port="{{port}}" index=[[index]] params="[[field.paramsAllowed]]" 
                port-error="[[field.portError]]" port-validator="[[field.portValidator]]"></port-item>
            </template>
        </div>
        <paper-button class="submit-btn add" on-tap="_addPort">
            <iron-icon icon="add"></iron-icon> Add
        </paper-button>
    </template>
    <script>
        Polymer({
            is: 'mist-ports-field',

            properties: {
                field: {
                    type: Object,
                    notify: true
                },
                ports: {
                    type: Array
                },
                valid: {
                    type: Boolean
                }
            },
            listeners: {
                'change': '_portsChanged',
                'port-delete': '_portDeleteHandler'
            },
            observers: [
                '_portsChanged(ports.splices)'
            ],
            ready: function() {
                if (!this.ports || !this.ports.length)
                    this._addPort();
            },
            _portsChanged: function() {
                this.$.ports.render();
            },
            _addPort: function() {
                var newPort = {
                    public: '',
                    private: '',
                    protocol: '',
                    params: ''
                };
                this.push('ports', newPort);
                this.$.ports.render();
            },
            _portsChanged: function(e) {
                var elements = this.shadowRoot.querySelectorAll('port-item');
                var value = {}, validities = [];
                elements.forEach(function(el){
                    if (el.value && typeof el.value == "object")
                        value[Object.keys(el.value)[0]] =  Object.values(el.value)[0];
                    validities.push(el.valid)
                })
                this.set('field.value', value);
                this._updateValid(validities);
                this.dispatchEvent(new CustomEvent('subform-fields-changed', {bubbles: true, composed: true}));
            },
            _portDeleteHandler: function(e) {
                var port = e.detail.port,
                    index = this.ports.indexOf(port);
                this.splice('ports', index, 1);
                this._portsChanged(e);
            },
            _updateValid: function(arr) {
                this.set('valid', arr.every(function(a) {
                    return a == true;
                }));
            }
        });
    </script>
</dom-module>