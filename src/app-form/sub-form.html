<link rel="import" href="app-form.html">

<dom-module id="sub-form">
        <template>
            <style is="custom-style" include="shared-styles forms">
                :host app-form {
                    border-left: 2px solid #eee;
                    border-bottom: 2px solid #eee;
                    padding-left: 16px;
                }
                .title {
                    margin-top: 16px;
                    margin-bottom: 8px;
                }
                paper-button.delete {
                    margin-bottom: 16px;
                    float: right;
                    transform: scale(.8);
                    margin-top: -6px;
                }
                paper-button.add {
                    margin-top: 16px !important;
                }
            </style>
            <template is="dom-repeat" items="[[items]]">
                <div class="title"><strong>[[itemName]] [[indexPlusOne(index)]]</strong></div>
                <app-form id="sub-form" fields="{{item.options}}" display-buttons="{{_calcDisplayButtons()}}"></app-form>
                <paper-button class="red delete" on-tap="deleteItem" hidden$="[[_computeShowDelete(index)]]">Delete [[itemName]]</paper-button>
                <br/>
            </template>
            <paper-button class="blue add" on-tap="addItem">Add [[itemName]]</paper-button>
        </template>
        <script>
            (function() {
                'use strict';
    
                Polymer({
                    is: 'sub-form',
                    /**
                     * Fired when a response is received.
                     *
                     * @event response
                     */
                    /**
                     * Fired when a request is made.
                     *
                     * @event request
                     */
                    /**
                     * Fired when the leadValue is changed.
                     *
                     * @event leadchange
                     */
                    properties: {
                        options: {
                            type: Array,
                            value: []
                        },
                        itemName: String,
                        items: {
                            type: Array,
                            value: [],
                            notify: true
                        },
                        fieldName: String,
                        min: {
                            type: Number,
                            value: 1
                        },
                        max: Number
                    },
                    observers: [
                        '_itemsChanged(items.splices, items.*.options)',
                        '_minChanged(min)'
                    ],
                    listeners: {
                        'keyup': '_itemsChanged'
                    },
                    _minChanged: function(min) {
                        for (var i=0; i<this.min; i++){
                            this.addItem();
                        }
                    },
                    _itemsChanged: function(){
                        // console.log('_itemsChanged');
                        this.fire('list-fields-changed');
                    },
                    _calcDisplayButtons: function() {
                        return false;
                    },
                    addItem: function () {
                        if (!this.max || this.items.length < this.max-1) {
                            var opts = this.options.slice(0);
                            opts.forEach(function(o){
                                o.value = o.defaultValue;
                            })
                            this.push('items', {options: opts});
                        }
                        else {
                            this.fire('toast', {msg: 'Only up to '+this.max+' '+this.itemName+'s are allowed.', duration: 3000});
                            this.querySelector('.add').setAttribute('disabled', true);
                        }
                        this.fire('list-fields-changed');
                    },
                    deleteItem: function (e) {
                        // console.log('deleteItem', e.model.__data__.index);
                        if (!this.min || this.items.length > this.min) {
                            this.splice('items', e.model.__data__.index, 1);
                            this.querySelector('.add').removeAttribute('disabled');
                            this.async(function(){
                                this.fire('list-fields-changed');
                            }.bind(this), 200)
                        }
                        else {
                            this.fire('toast', {msg: 'Minimun '+this.max+' '+this.itemName+'s are required.', duration: 3000})
                        }
                    },
                    indexPlusOne: function(i){
                        return i+1;
                    },
                    _computeShowDelete: function(index){
                        return this.min ? index < this.min : true;
                    }
                });
            })();
        </script>
    </dom-module>
                        
    