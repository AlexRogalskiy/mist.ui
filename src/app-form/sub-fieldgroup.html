<link rel="import" href="app-form.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<dom-module id="sub-fieldgroup">
    <template>
        <style include="shared-styles forms">
            :host {
                width: 50%;
            }
            :host([optional]) app-form {
                padding-left: 46px; 
            }
            paper-toggle-button {
                margin-top: 16px;
                margin-bottom: 16px;
            }
        </style>
        <template is="dom-if" if="[[optional]]" restamp>
            <paper-toggle-button id$="[[id]]-[[field.name]]-toggler" checked="{{enabled}}">
                <span>[[field.label]]</span>
            </paper-toggle-button>
        </template>
        <template is="dom-if" if="[[_showForm(optional,enabled)]]" restamp>
            <app-form id$="[[id]]" form="{{fieldValue}}" fields="{{field.subfields}}" display-buttons="[[_calcDisplayButtons()]]" single-column></app-form>
        </template>
    </template>
    <script>
        Polymer({
            is: 'sub-fieldgroup',
            /**
             * Fired when a response is received.
             *
             * @event response
             */
            /**
             * Fired when a request is made.
             *
             * @event request
             */
            /**
             * Fired when the leadValue is changed.
             *
             * @event leadchange
             */
            properties: {
                id: {
                    type: String
                },
                field: {
                    type: Object
                },
                optional: {
                    type: Boolean,
                    reflectToAttribute: true
                },
                enabled: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                    observer: '_enabledChanged'
                }
            },
            observers: [
                '_fieldChanged(field)',
                '_subfieldsChanged(field.subfields.*)'
            ],  
            listeners: {
                'fields-changed': '_updateFields'
            },
            _enabledChanged: function(enabled) {
                if (!this.enabled) {
                    this._resetValue();
                }
            },
            _resetValue: function() {
                this.set('field.value', {});
            },
            _fieldChanged: function(field) {
                var form = this.shadowRoot.querySelector('app-form#'+this.id);
                if (form) {
                    form.dispatchEvent(new CustomEvent('fields-changed',{ bubbles: true, composed: true}));
                }
            },
            _updateFields: function() {
                this._subfieldsChanged(this.subfields);
            },
            _subfieldsChanged: function(subfields) {
                var fieldValue = {};
                for (var i=0; i<this.field.subfields.length; i++) {
                    fieldValue[this.field.subfields[i].name] = this.field.subfields[i].value;
                }
                this.set('field.value', fieldValue);
                // this.shadowRoot.querySelector('app-form#'+this.id).dispatchEvent(new CustomEvent('fields-changed',{ bubbles: true, composed: true}));

            },
            _calcDisplayButtons: function(){
                return false;
            },
            _showForm: function(optional, enabled) {
                return optional ? enabled : true;
            }
        });
    </script>
</dom-module>