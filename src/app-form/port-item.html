<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-input-error.html">
<link rel="import" href="../../bower_components/iron-input/iron-input.html">
<link rel="import" href="../../bower_components/iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="port-validator.html">

<dom-module id="port-item">
    <template>
        <style include="shared-styles tags-and-labels">
             :host {
                position: relative;
                display: block;
                margin-bottom: 16px;
            }

            .input-box, .input-box-2  {
                @apply --layout-horizontal;
                max-width: 100%;
                align-items: center;
                position: relative;
            }
            .input-box-2 {
                padding-left: 30px;
            }

            strong {
                margin: 30px 8px 8px;
                font-size: 16px;
            }
            input {
                border: 0 none;
                padding: 2px;
            }
            paper-input {
                font-family: monospace !important;
            }
            paper-icon-button {
                padding: 0;
                position: absolute;
                right: -23px;
                width: 16px;
                height: 16px;
                opacity: .9;
                top: 32px;
            }
            span {
                line-height: 1.6em;
                padding: 8px 2px;
                align-self: flex-end;
            }
            p.error {
                position: absolute;
                font-size: 0.8em;
                display: block;
                margin-top: 0;
                color: var(--paper-input-container-invalid-color, var(--error-color));
            }
        </style>
        <port-validator validator-name="port-validator"></port-validator>
        <div class="input-box">
            <strong>[[newIndex]].</strong>
            <paper-input auto-focus value="{{_public}}" aria-label="Public *" label="Public port" size="15" required always-float-label
            auto-validate validator='port-validator' error-message="Public port cannot be empty">
            </paper-input>
            <span>:</span>
            <paper-input value="{{_private}}" aria-label="Private *" label="Private port"  size="15" required always-float-label
            auto-validate validator='port-validator' error-message="Private port cannot be empty">
            </paper-input>
        </div>
        <div class="input-box-2">
            <paper-dropdown-menu aria-label="Protocol" label="Protocol *" required always-float-label
            on-focus="_enableValidateProtocol" on-blur="_validateProtocol">
                <paper-listbox slot="dropdown-content" attr-for-selected="value" selected="{{_protocol}}">
                    <paper-item value="tcp">TCP</paper-item>
                    <paper-item value="udp">UDP</paper-item>
                </paper-listbox>
            </paper-dropdown-menu>
            <paper-input value="{{_params}}" aria-label="Other params, comma-separated" label="Other params. Comma-separated" size="55" 
            always-float-label>
            </paper-input>
        </div>
        <div class="input-box-2">
            <p class="error" hidden$="[[!_showError]]">A protocol must be selected</p>
        </div>
        <paper-icon-button icon="delete" on-tap="_deletePort"></paper-icon-button>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'port-item',
        behaviors: [Polymer.IronValidatableBehavior],
        properties: {
            port: {
                type: Object,
                notify: true
            },
            value: {
                type: Object,
                notify: true
            },
            index: {
                type: Number
            },
            _public: {
                type: Number
            },
            _private: {
                type: String, 
                value: ''
            },
            _protocol: {
                type: String, 
                value: ''
            },
            _params: {
                type: String, 
                value: ''
            },
            newIndex: {
                type: Number,
                computed: '_computeNewIndex(index)'
            },
            _canValidate: {
                type: Boolean,
                value: false
            },
            _showError: {
                type: Boolean,
                value: false
            },
            valid: {
                type: Boolean,
                value: false,
                reflectToAttribute: true,
                computed: '_computeValid(_private,_public,_protocol)'
            }
        },
        observers: [
            '_computeValue(_private,_public,_protocol,_params)',
            '_portChanged(port)',
            '_validateProtocol(_protocol)'
        ],
        _computeNewIndex: function (index) {
            return index + 1;
        },
        _enableValidateProtocol: function(e) {
            this.set('_canValidate', true);
        },
        _validateProtocol: function(e) {
            // Validate paper-dropdown, if it has been focused once and the the listbox is not open
            if (this._canValidate && this.shadowRoot.querySelector('paper-listbox').getAttribute('aria-expanded') == "false")
                this.set('_showError', !this._protocol);
        },
        _computeValid: function(_private,_public,_protocol) {
            // TODO: This should get .valid values for each paper-inputs according to port-validator 
            return _private && _public && ['udp', 'tcp'].indexOf(_protocol) > -1;
        },
        _portChanged: function(port) {
            if (port) {
                this.set('_public', port.public);
                this.set('_private', port.private);
                this.set('_protocol', port.protocol);
                this.set('_params', port.params);
            }
        },
        _deletePort: function (e) {
            var that = this;
            this.dispatchEvent(new CustomEvent('port-delete', { bubbles: true, composed: true, detail: {
                port: that.port
            } }));
        },
        _computeValue: function(_public, _private, _protocol, _params) {
            if (_private && _public && _protocol) {
                var key =  _public.trim() + ':' + _private.trim();
                var val = [];
                    val.push(_protocol);
                if (_params)
                    val = val.concat(_params.split(','))
                this.value = {};
                this.value[key] = val;
                this.dispatchEvent(new CustomEvent('change', { bubbles: true, composed: true }));
            }
        }
    });
</script>