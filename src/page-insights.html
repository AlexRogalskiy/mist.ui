<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/mist-list/mist-list.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../bower_components/mist-insights/mist-insights.html">

<script src="../bower_components/moment/moment.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<dom-module id="page-insights">
    <template>
    <style include="shared-styles forms single-page tags-and-labels">
        :host {
            /*--insights-general-font*/
            --insights-general-font-font-family: 'Roboto', 'Noto', sans-serif;
            --insights-general-font-font-size: 16px;
            --insights-general-font-line-height: 1.8em;
            --insights-general-font-color: rgba(0,0,0,0.87);

            /*--insights-h2*/
            --insights-h2-font-size: 2.4em;
            --insights-h2-margin: 0 !important;
            --insights-h2-font-weight: 400;
            --insights-h2-letter-spacing: 0;
            --insights-h2-line-height: 48px;

            /*--insights-h2-title*/
            --insights-h2-title-font-size: 1.6em;
            --insights-h2-title-margin: 0 !important;

            /*--insights-legends*/
            --insights-legends-text-transform: uppercase;
            --insights-legends-font-size: 0.9em;
            --insights-legends-color: rgba(0,0,0,0.54);

            /*--material-css*/
            --material-css-padding: 24px;
            --material-css-margin-bottom: 16px;

            --red-color: #e82438;
            --green-color: #38b549;
        }
        .opaque {
            opacity: 0.34
        }
        .error iron-icon {
            opacity: 0.32;
            cursor: pointer;
        }
        .error {
            color: var(--red-color);
        }
        .blue {
            color: var(--mist-blue);   
        }
        :host mist-insights ::slotted(#quick-overview-data) {
            flex-wrap: wrap;
            justify-content: space-between;
        }
        :host mist-insights ::slotted(#quick-overview-data > div) {
            min-width: 160px;
        }
        :host mist-insights ::slotted(#quick-overview-data > div .smaller) {
            padding-right: 24px;
        }
        @media screen and (max-width: 560px) {
            :host mist-insights ::slotted(#quick-overview-data > div) {
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 1px solid #ddd;
            }
        }
        @media screen and (max-width: 425px) {
            :host mist-insights ::slotted(.head) {
                flex-direction: column;
            }
            :host mist-insights ::slotted(.head > div) {
                text-align: left;
                padding-left: 0;
                margin-top: 12px;
                margin-bottom: 12px;
                padding-bottom: 12px;
                border-bottom: 1px solid #ddd;
            }
        }
        @media screen and (max-width: 634px) {
            :host mist-insights ::slotted(paper-button.clear) {
                padding-left: 0;
                margin-left: 0;
            }
        }
    </style>
    <app-route route="{{route}}"></app-route>
    <iron-media-query query="(min-width: 1180px)" query-matches="{{largescreen}}"></iron-media-query>

    <div id="content" class="content404" hidden$="[[insightsEnabled]]">
        <h1>404</h1>
        <p>Insights is not enabled for this organization account.<br/>
        Contact <a href$="mailto:[[email.info]]"><span class="info-email"></span></a> for more information.</p>
    </div>
    <div id="content" hidden="[[!insightsEnabled]]">
        <mist-insights model="[[model]]" period="week" currency=[[currency]]></mist-insights>
        <paper-button on-tap="_exportPdf" class="action"><iron-icon icon="image:picture-as-pdf"></iron-icon> Export pdf </paper-button>
    </div>

    </template>
    <script>
        Polymer({
            is: 'page-insights',
            behaviors: [
                Polymer.IronResizableBehavior
            ],
            properties: {
                email: {
                    type: Object
                },
                model: {
                    type: Object
                },
                insightsEnabled: {
                    type: Boolean,
                    computed: "_computeInsightsEnabled(model.org.*)",
                    value: false
                },
                largescreen: {
                    type: Boolean
                },
                currency: {
                    type: Object
                }
            },
            _computeInsightsEnabled: function(modelorg){
                return this.model && this.model.org && this.model.org.insights_enabled != undefined ? this.model.org.insights_enabled : false;
            },
            _exportPdf: function() {
                let generatePdf = function() {
                    getQuarter = function (date){
                        return Math.ceil((date.getMonth() + 1) / 3)
                    }
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    let offset=20;
                    const mistInsightsElement = this.shadowRoot.querySelector('mist-insights')
                    const period = mistInsightsElement.getAttribute('period')
                    const costOverview = mistInsightsElement.shadowRoot.querySelector('#cost_overview').querySelector(".head");
                    const head = costOverview.querySelector(".title")
                    const filtrs = costOverview.querySelectorAll(".filterby.highlight");
                    let infrastructure = ""
                    for(const filtr of filtrs){
                        if(!filtr.hidden){
                            infrastructure = filtr;
                            break;
                        }
                    }
                    const cost_overview_right = costOverview.querySelector(".current-value");
                    const graphs = mistInsightsElement.shadowRoot.querySelector('#graphRow');
                    const first_graph = graphs.querySelector("#costGraph").childNodes[0].childNodes[0];
                    const second_graph = graphs.querySelector('#drillcostgraph').childNodes[0].childNodes[0];
                    const by_cloud_list = graphs.querySelector('#costListByCloud').querySelector(".list").querySelectorAll('.layout.horizontal')
                    const by_tag_list = graphs.querySelector('#costListByTag').querySelector(".list").querySelectorAll('.layout.horizontal')
                    let toDate = new Date();
                    const nameDate = toDate.toLocaleString().replace("/", "_").replace("/","_").replace(", ","_").replace(":","_").replace(" ", "_");
                    let fromDate = new Date();
                    let timePeriod = fromDate.toLocaleDateString() + " 00:00 - " + toDate.getHours() + ":00";
                    const currentQuarter = getQuarter(toDate);
                    const dateText = cost_overview_right.innerText.toLowerCase();
                    const costData = graphs.querySelector(".comparative").innerText.toLowerCase().split('run rate');
                    costData[0] += "Run Rate"
                    if(dateText.includes('last hour')){
                        fromDate.setHours(toDate.getHours() - 1)
                        timePeriod = toDate.toLocaleDateString();
                        timePeriod += " " + fromDate.getHours() + ":00 - " + toDate.getHours() + ":00"
                    }else if(dateText.includes('last hour')){
                        toDate.setHours(toDate.getHours() - 1);
                        fromDate.setHours(toDate.getHours() - 2)
                        timePeriod = toDate.toLocaleDateString();
                        timePeriod += " " + fromDate.getHours() + ":00 - " + toDate.getHours() + ":00"
                    } else if (dateText.includes('hours ago')) {
                        if (dateText.includes('2')){
                            toDate.setHours(toDate.getHours() - 2);
                            fromDate.setHours(toDate.getHours() - 3)
                        } else if (dateText.includes('3')){
                            toDate.setHours(toDate.getHours() - 3);
                            fromDate.setHours(toDate.getHours() - 4);
                        } else if (dateText.includes('4')){
                            toDate.setHours(toDate.getHours() - 4);
                            fromDate.setHours(toDate.getHours() - 5);
                        } else if (dateText.includes('5')){
                            toDate.setHours(toDate.getHours() - 5);
                            fromDate.setHours(toDate.getHours() - 6);
                        } else if (dateText.includes('6')){
                            toDate.setHours(toDate.getHours() - 6);
                            fromDate.setHours(toDate.getHours() - 7);
                        } else if (dateText.includes('7')){
                            toDate.setHours(toDate.getHours() - 7);
                            fromDate.setHours(toDate.getHours() - 8);
                        } else if (dateText.includes('8')){
                            toDate.setHours(toDate.getHours() - 8);
                            fromDate.setHours(toDate.getHours() - 9);
                        } else if (dateText.includes('9')){
                            toDate.setHours(toDate.getHours() - 9);
                            fromDate.setHours(toDate.getHours() - 10);
                        } else if (dateText.includes('10')){
                            toDate.setHours(toDate.getHours() - 10);
                            fromDate.setHours(toDate.getHours() - 11);
                        }
                        timePeriod = toDate.toLocaleDateString();
                        timePeriod += " " + fromDate.getHours() + ":00 - " + toDate.getHours() + ":00";

                    } else if (dateText.includes('yesterday')) {
                        toDate.setDate(toDate.getDate() - 1);
                        fromDate = toDate;
                        timePeriod = fromDate.toLocaleDateString() + " - ";
                        timePeriod += toDate.toLocaleDateString();
                    } else if (dateText.includes('days ago')) {
                        if (dateText.includes('2')){
                            toDate.setDate(toDate.getDate() - 2);
                            fromDate = toDate;
                        } else if (dateText.includes('3')){
                            toDate.setDate(toDate.getDate() - 3);
                            fromDate = toDate;
                        } else if (dateText.includes('4')){
                            toDate.setDate(toDate.getDate() - 4);
                            fromDate = toDate;
                        } else if (dateText.includes('5')){
                            toDate.setDate(toDate.getDate() - 5);
                            fromDate = toDate;
                        } else if (dateText.includes('6')){
                            toDate.setDate(toDate.getDate() - 6);
                            fromDate = toDate;
                        } else if (dateText.includes('7')){
                            toDate.setDate(toDate.getDate() - 7);
                            fromDate = toDate;
                        } else if (dateText.includes('8')){
                            toDate.setDate(toDate.getDate() - 8);
                            fromDate = toDate;
                        } else if (dateText.includes('9')){
                            toDate.setDate(toDate.getDate() - 9);
                            fromDate = toDate;
                        } else if (dateText.includes('10')){
                            toDate.setDate(toDate.getDate() - 10);
                            fromDate = toDate;
                        }
                        timePeriod = fromDate.toLocaleDateString() + " - ";
                        timePeriod += toDate.toLocaleDateString();
                    } else if(dateText.includes("this week")){
                        fromDate.setDate(fromDate.getDate()-7);
                        timePeriod = fromDate.toLocaleDateString() + " - ";
                        timePeriod += toDate.toLocaleDateString();
                    } else if(dateText.includes("last week")){
                        toDate.setDate(toDate.getDate()-7);
                        fromDate.setDate(fromDate.getDate()-14);
                        timePeriod = fromDate.toLocaleDateString() + " - ";
                        timePeriod += toDate.toLocaleDateString();
                    } else if(dateText.includes("two weeks ago")){
                        toDate.setDate(toDate.getDate()-14);
                        fromDate.setDate(fromDate.getDate()-21);
                        timePeriod = fromDate.toLocaleDateString() + " - ";
                        timePeriod += toDate.toLocaleDateString();
                    } else if(dateText.includes("three weeks ago")){
                        toDate.setDate(toDate.getDate()-21);
                        fromDate.setDate(fromDate.getDate()-28);
                        timePeriod = fromDate.toLocaleDateString() + " - ";
                        timePeriod += toDate.toLocaleDateString();
                    } else if(dateText.includes("this month")){
                        fromDate.setDate(1);
                        timePeriod = fromDate.toLocaleDateString() + " - ";
                        timePeriod += toDate.toLocaleDateString();
                    } else if(dateText.includes('last month')){
                        fromDate.setMonth(fromDate.getMonth() - 1);
                        fromDate.setDate(1);
                        toDate.setDate(1);
                        timePeriod = fromDate.toLocaleDateString() + " - ";
                        timePeriod += toDate.toLocaleDateString();
                    } else if(dateText.includes('months ago')){
                        if(dateText.includes('2')){
                            fromDate.setMonth(fromDate.getMonth() - 2);
                            fromDate.setDate(1);
                            toDate.setMonth(toDate.getMonth() - 1);
                            toDate.setDate(1);
                        } else if(dateText.includes('3')){
                            fromDate.setMonth(fromDate.getMonth() - 3);
                            fromDate.setDate(1);
                            toDate.setMonth(toDate.getMonth() - 2);
                            toDate.setDate(1);
                        } else if(dateText.includes('4')){
                            fromDate.setMonth(fromDate.getMonth() - 4);
                            fromDate.setDate(1);
                            toDate.setMonth(toDate.getMonth() - 3);
                            toDate.setDate(1);
                        } else if(dateText.includes('5')){
                            fromDate.setMonth(fromDate.getMonth() - 5);
                            fromDate.setDate(1);
                            toDate.setMonth(toDate.getMonth() - 4);
                            toDate.setDate(1);
                        } else if(dateText.includes('6')){
                            fromDate.setMonth(fromDate.getMonth() - 6);
                            fromDate.setDate(1);
                            toDate.setMonth(toDate.getMonth() - 5);
                            toDate.setDate(1);
                        } else if(dateText.includes('7')){
                            fromDate.setMonth(fromDate.getMonth() - 7);
                            fromDate.setDate(1);
                            toDate.setMonth(toDate.getMonth() - 6);
                            toDate.setDate(1);
                        } else if(dateText.includes('8')){
                            fromDate.setMonth(fromDate.getMonth() - 8);
                            fromDate.setDate(1);
                            toDate.setMonth(toDate.getMonth() - 7);
                            toDate.setDate(1);
                        } else if(dateText.includes('9')){
                            fromDate.setMonth(fromDate.getMonth() - 9);
                            fromDate.setDate(1);
                            toDate.setMonth(toDate.getMonth() - 8);
                            toDate.setDate(1);
                        } else if(dateText.includes('10')){
                            fromDate.setMonth(fromDate.getMonth() - 10);
                            fromDate.setDate(1);
                            toDate.setMonth(toDate.getMonth() - 9);
                            toDate.setDate(1);
                        } else if(dateText.includes('11')){
                            fromDate.setMonth(fromDate.getMonth() - 11);
                            fromDate.setDate(1);
                            toDate.setMonth(toDate.getMonth() - 10);
                            toDate.setDate(1);
                        } 
                        timePeriod = fromDate.toLocaleDateString() + " - ";
                        timePeriod += toDate.toLocaleDateString();
                    } else if(dateText.includes("quarter")){
                        let quarter;
                        let quarterPeriod;
                        if (dateText.includes('current')){
                            quarter = currentQuarter;
                        } else if (dateText.includes('previous')){
                            quarter = currentQuarter - 1;
                        } else if (dateText.includes('2')){
                            quarter = currentQuarter - 2;
                        } else if (dateText.includes('3')){
                            quarter = currentQuarter - 3;
                        }
                        if (quarter <= 0){                            
                            quarter = 4 + quarter;
                            toDate.setFullYear(toDate.getFullYear() -1);
                            fromDate.setFullYear(fromDate.getFullYear() -1);
                        }
                        if(quarter == 1){
                            fromDate.setMonth(1);
                            fromDate.setDate(1);
                            toDate.setMonth(3);
                            toDate.setDate(1);
                            quarterPeriod = "1st Quarter";
                        } else if (quarter == 2){
                            fromDate.setMonth(4);
                            fromDate.setDate(1);
                            toDate.setMonth(6);
                            toDate.setDate(1);
                            quarterPeriod = "2nd Quarter";
                        } else if (quarter == 3){
                            fromDate.setMonth(7);
                            fromDate.setDate(1);
                            toDate.setMonth(9);
                            toDate.setDate(1);
                            quarterPeriod = "3rd Quarter";
                        } else if (quarter == 4){
                            fromDate.setMonth(10);
                            fromDate.setDate(1);
                            toDate.setMonth(12);
                            toDate.setDate(1);
                            quarterPeriod = "4th Quarter";
                        }
                        if (dateText.includes('current')){
                            toDate = new Date();
                        }
                        timePeriod = fromDate.getFullYear() + " - " + quarterPeriod;
                    }
                    const name = 'Costs-' + period + "-" + nameDate + ".pdf";
                    const price = "Cost: " + cost_overview_right.innerText.split('\n')[1];
                    pdf.setFontSize(20);
                    pdf.setFontStyle("bold");
                    pdf.text("Mist.io Insights Cost Report", 55, offset-10);
                    pdf.fromHTML(head.outerHTML, 10, offset);
                    //pdf.fromHTML(cost_overview_right.outerHTML,160, offset+5);
                    pdf.fromHTML(infrastructure.innerText,12, offset+15)
                    pdf.setFontSize(12);
                    pdf.setTextColor(0);
                    pdf.setFontStyle('bold');
                    pdf.text(timePeriod, 160, offset+11);
                    pdf.setFontSize(14);
                    pdf.setFontStyle('normal');
                    pdf.text(price, 170, offset+20);
                    pdf.setTextColor(128);
                    let txt = "-".repeat(200)
                    pdf.text(txt, 5, offset+25);
                    pdf.setTextColor(100);
                    pdf.setFontStyle(12);
                    offset += 30
                    for (const data of costData){
                        pdf.text(data.trim(), 10, offset);
                        offset += 5;

                    }
                    pdf.setFontSize(10);
                    pdf.setTextColor(128);
                    pdf.text("Run Rate ($/month)",10, 63)
                    pdf.addImage(first_graph.toDataURL('image/png'), 'PNG', 10, 65);
                    //const new_y = parseInt(first_graph.getAttribute('height'));
                    pdf.text("Cost by Cloud", 10, 175);                    
                    pdf.addImage(second_graph.toDataURL('image/png'), 'PNG', 10, 180);
                    pdf.addPage();
                    offset = 10;
                    pdf.setFontSize(14);
                    pdf.text("Cost by Cloud", 10, offset);
                    offset += 7;
                    pdf.setFontSize(12);
                    pdf.setTextColor(0);
                    for(let i=0; i<by_cloud_list.length; i++){
                        const txts = by_cloud_list[i].innerText.split('\n');
                        txt = (i+1) + ". " + txts[1];
                        pdf.text(txt, 10, offset);
                        pdf.text(txts[2], 50, offset);
                        pdf.text(txts[3], 90, offset);
                        offset += 8;
                    }
                    offset += 8;
                    pdf.setTextColor(128);
                    pdf.setFontSize(14);
                    pdf.text("Cost by Tag", 10, offset);
                    offset += 8;
                    pdf.setTextColor(0);
                    pdf.setFontSize(12);
                    for(let i=0; i<by_tag_list.length; i++){
                        const txts = by_tag_list[i].innerText.split('\n');
                        txt = (i+1) + ". " + txts[1];
                        pdf.text(txt, 10, offset);
                        pdf.text(txts[2], 50, offset);
                        pdf.text(txts[3], 90, offset);
                        offset += 8;
                    }
                    pdf.save(name);
                }.bind(this);
            try {
                new jsPDF();
                generatePdf();
            } catch (e) { // import jspdf if not loaded
                return this.dispatchEvent(
                    new CustomEvent('import-script', {
                        bubbles: true, composed: true, detail: {
                            url: 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js',
                            cb: generatePdf
                        }
                    }));
            }
        }
        });
    </script>
</dom-module>
