<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-material/paper-material.html">
<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">

<script src="../bower_components/moment/moment.js"></script>

<link rel="import" href="../bower_components/chart-elements/chart-elements.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">


<dom-module id="page-insights">
    <template>
    <style is="custom-style" include="tags-and-labels"></style>
    <style is="custom-style" include="forms"></style>
    <style is="custom-style" include="single-page"></style>
    <style is="custom-style">
        :host {
            display: block;
        }
        paper-material {
            padding: 24px;
            position: relative;
        }
        paper-material.margin-botttom {
            margin-bottom: 16px;
        }
        paper-spinner {
            margin: 10% calc(50% - 40px);
            width: 80px !important;
            height: 80px !important;
        }
        .error iron-icon {
            opacity: 0.32;
            cursor: pointer;
        }
        .error {
            color: var(--red-color);
        }
        .smaller {
            text-transform: uppercase;
            font-size: 0.9em;
            color: rgba(0,0,0,0.54)
        }
        .flex-horizontal {
            @apply(--layout-horizontal);
        }
        .flexchild {
            @apply(--layout-flex);
        }
        .uppercase,
        paper-dropdown-menu.uppercase paper-item,
        paper-dropdown-menu.uppercase ::content #input {
            text-transform: uppercase;
        }
        .uppercase.tag {
            text-transform: none;
        }
        h2.title {
            font-size: 1.6em;
            margin: 0 !important;
        }
        .cost-section {
            text-align: right;
        }
        .cost {
            font-size: 2.4em;
            margin: 0;
        }
        .sup {
            vertical-align: super;
            font-size: 0.55em;
            opacity: 0.34;
        }
        .filterby {
            display: inline-block;
        }
        .highlight {
            background-color: #ffff8d;
            padding: 2px;
        }
        chart-line {
            width: 600px;
            display: inline-block;
        }
        chart-doughnut {
            width: 220px;
            vertical-align: top;
            display: inline-block;
        }
        #graphRow[largescreen]  {
            display: flex;
        }
        .inline {
            display: inline-block;
            vertical-align: top;
        }
        .padding {
            padding: 16px;
        }
        #graphRow[largescreen] .block + .block {
            padding-left: 48px;
        }
        .row {
            line-height: 1.8em;
            margin-top: 16px;
        }
        .list {
            margin-top: 16px;
            margin-bottom: : 16px;
        }
        .name-col {
            width: 40%;
        }
        .machines {
            opacity: 0.54;
        }
        .tag {
            vertical-align: middle;
            line-height: 1.6em;
        }
        .loading-data {
            position: absolute;
            background-color: rgba(255,255,255,0.9);
            width: 100%;
            height: 100%;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            z-index: 2;
        }
        .red {
            color: var(--red-color);
        }
        .opaque {
            opacity: 0.34
        }
        .recommendation-list {
            font-size: 0.9em;
        }
        ul {
            padding: 0;
            list-style: none;
        }
    </style>
    <app-route route="{{route}}"></app-route>
    <iron-media-query query="(min-width: 1180px)" query-matches="{{largescreen}}"></iron-media-query>

    <div id="content">
        <paper-material class="margin-botttom">
            <div class="container flex-horizontal">
                <div class="flexchild">
                    <div class="smaller">Time</div>
                    <paper-dropdown-menu class="uppercase" no-label-float>
                        <paper-menu id="window" class="dropdown-content" attr-for-selected="value" selected="{{timeParams.window}}">
                            <paper-item value="hour">hourly</paper-item>
                            <paper-item value="day">daily</paper-item>
                            <paper-item value="week">weekly</paper-item>
                            <paper-item value="month">monthly</paper-item>
                            <paper-item value="quarter">quarterly</paper-item>
                        </paper-menu>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu class="uppercase" no-label-float>
                        <paper-menu id="past" class="dropdown-content" attr-for-selected="value" selected="{{timeParams.past}}">
                            <template is="dom-repeat" items="{{pastItems}}" as="past">
                                <paper-item value="[[past.value]]">[[past.text]]</paper-item>
                            </template>
                        </paper-menu>
                    </paper-dropdown-menu>
                </div>
                <div class="flexchild">
                    <div class="smaller">Filter by</div>
                    <paper-dropdown-menu class="uppercase" no-label-float>
                        <paper-menu id="filterbyType" class="dropdown-content" attr-for-selected="value" selected="{{filterby.type}}">
                            <paper-item value="stack">Stack</paper-item>
                            <paper-item value="cloud">Cloud</paper-item>
                            <paper-item value="tag">Tag</paper-item>
                        </paper-menu>
                    </paper-dropdown-menu>
                    <paper-dropdown-menu class="uppercase" no-label-float>
                        <paper-menu id="filterbyName" class="dropdown-content" attr-for-selected="value" selected="{{filterby.name}}">
                            <template is="dom-repeat" items="{{filterbyItems}}">
                                <paper-item value="[[item.name]][[item.title]]">[[item.name]][[item.title]]</paper-item>
                            </template>
                            <paper-item disabled hidden$="{{!filterbyDisable}}">no {{filterby.type}}s</paper-item>
                        </paper-menu>
                    </paper-dropdown-menu>
                </div>
            </div>
        </paper-material>
        <paper-material class="margin-botttom">
            <div class="loading-data" hidden="{{!loadingData}}">
            </div>
            <div class="container flex-horizontal">
                <div class="flexchild">
                    <div class="smaller">Cost Overview</div>
                    <h2 class="cost"><span class="sup">$</span>[[_toFixed(report.cost)]]</h2>
                    <div class="smaller"><span class="red">X% Above</span> previous [[timeParams.window]]</div>
                </div>
                <div class="flexchild">
                    <div class="smaller">Machine Count</div>
                    <h2 class="cost"><span class="sup"></span>[[machinesCount]]</h2>
                    <div class="smaller">X more this [[timeParams.window]]</div>
                </div>
                <div class="flexchild opaque">
                    <div class="smaller">Average load</div>
                    <h2 class="cost"><span class="sup"></span>XX%</h2>
                    <div class="smaller">X% below previous [[timeParams.window]]</div>
                </div>
                <div class="flexchild opaque">
                    <div class="smaller">Recommendations</div>
                    <ul class="recommendation-list">
                        <li><iron-icon class="red" icon="icons:warning"></iron-icon>Sudden rise of cost comparing to previous month</li>
                    </ul>
                </div>
            </div>
        </paper-material>
        <paper-material>
            <div class="container flex-horizontal">
                <div class="flexchild">
                    <h2 class="title">Cost Overview</h2>
                    <div class="filterby highlight" hidden$="[[!filterby.type.length]]"><span class="uppercase">for [[filterby.type]]:</span><span class="uppercase [[filterby.type]]"> [[filterby.name]] <span hidden$="[[filterby.name.length]]">select [[filterby.type]]</span></div>
                    <div class="filterby highlight" hidden$="[[filterby.type.length]]">All infrastructure</div>
                </div>
                <div class="cost-section">
                    <div class="smaller">Cost</div>
                    <h2 class="cost"><span class="sup">$</span>[[_toFixed(report.cost)]]</h2>
                </div>
            </div>
        </paper-material>
        <paper-material class="margin-botttom">
            <div class="loading-data" hidden="{{!loadingData}}">
                <paper-spinner active="{{loadingData}}"></paper-spinner>
            </div>
            <div id="graphRow" class="row" largescreen$="{{largescreen}}">
                <div class="block flex">
                    <div class="row">
                        <div class="smaller">Run Rate ($/mo)</div>
                    </div>
                    <chart-line id="costgraph" data="[[costData]]" type="line" style$="width: [[graphWidth]]px"></chart-line>
                </div>
                <div class="block flex">
                    <div class="row" hidden$="[[!showRing]]">
                        <div class="smaller">[[ringTitle]]</div>
                    </div>
                    <div class="row flex-horizontal" hidden$="[[!showRing]]">
                        <chart-doughnut id="drillcostgraph" data="[[costDrillData]]" type="doughnut" style$="width: [[doughnutWidth]]px"></chart-doughnut>
                        <div id="drillcostlist" class="flex">
                            <div class="list">
                                <template is="dom-repeat" items="{{costDrillList}}">
                                    <div class="flex-horizontal">
                                        <span class="name-col">
                                            [[_index(index)]].  [[item.name]]
                                            <span hidden$="[[item.name.length]]">others</span>
                                        </span>
                                        <div class="flexchild machines">
                                            [[item.machine_count]] machines
                                        </div>
                                        <span>
                                            $[[_toFixed(item.cost)]]
                                        </span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <div class="row" hidden$="[[!showFirstList]]">
                        <div class="smaller">[[firstListTitle]]</div>
                        <div class="list">
                            <template is="dom-repeat" items="{{costDrillList1}}">
                                <div class="flex-horizontal">
                                        <span class="name-col">
                                            [[_index(index)]]. 
                                            <span class="tag" hidden$="[[!item.name.length]]">[[item.name]]</span>
                                            <span hidden$="[[item.name.length]]">others</span> 
                                        </span>
                                        <div class="flexchild machines">
                                            [[item.machine_count]] machines 
                                        </div>
                                        <span>
                                            $[[_toFixed(item.cost)]]
                                        </span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="row" hidden$="[[!showSecondList]]">
                        <div class="smaller">[[secondListTitle]]</div>
                        <div class="list">
                            <template is="dom-repeat" items="{{costDrillList2}}">
                                <div class="flex-horizontal">
                                        <span class="name-col">
                                            [[_index(index)]].
                                            <span class="tag" hidden$="[[!item.name.length]]">[[item.name]]</span>
                                            <span hidden$="[[item.name.length]]">others</span>
                                        </span>
                                        <div class="flexchild machines">
                                            [[item.machine_count]] machines
                                        </div>
                                        <span>
                                            $[[_toFixed(item.cost)]]
                                        </span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </paper-material>

        <paper-material>
            <div class="container flex-horizontal">
                <div class="flexchild">
                    <h2 class="title">Machines Overview</h2>
                    <div class="filterby highlight" hidden$="[[!filterby.type.length]]"><span class="uppercase">for [[filterby.type]]:</span><span class="uppercase [[filterby.type]]"> [[filterby.name]] <span hidden$="[[filterby.name.length]]">select [[filterby.type]]</span></div>
                    <div class="filterby highlight" hidden$="[[filterby.type.length]]">All infrastructure</div>
                </div>
                <div class="cost-section">
                    <div class="smaller">Count</div>
                    <h2 class="cost">[[machinesCount]]</h2>
                </div>
            </div>
        </paper-material>
        <paper-material class="margin-botttom">
            <div class="loading-data" hidden="{{!loadingData}}">
                <paper-spinner active="{{loadingData}}"></paper-spinner>
            </div>
            <div id="graphRow" class="row" largescreen$="{{largescreen}}">
                <div class="block flex">
                    <div class="row">
                        <div class="smaller">Machines count</div>
                    </div>
                    <chart-bar id="machinesgraph" data="[[machinesData]]" type="bar" style$="width: [[graphWidth]]px"></chart-bar>
                </div>
                <div class="block flex">
                    <!-- <div class="row">
                        <div class="smaller">Added vms</div>
                        <div class="list">
                            <template is="dom-repeat" items="{{addedVms}}">
                                <div class="flex-horizontal">
                                        <span class="name-col">
                                            [[_index(index)]].
                                            <span class="name" hidden$="[[!item.name.length]]">[[item.name]]</span>
                                            <span hidden$="[[item.name.length]]">others</span>
                                        </span>
                                        <div class="flexchild machines">
                                            [[item.date]]
                                        </div>
                                        <div class="flexchild machines">
                                            [[item.provider]]
                                        </div>
                                        <span>
                                            $[[_toFixed(item.cost)]]
                                        </span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="row">
                        <div class="smaller">deleted vms</div>
                        <div class="list">
                            <template is="dom-repeat" items="{{addedVms}}">
                                <div class="flex-horizontal">
                                        <span class="name-col">
                                            [[_index(index)]].
                                            <span class="name" hidden$="[[!item.name.length]]">[[item.name]]</span>
                                            <span hidden$="[[item.name.length]]">others</span>
                                        </span>
                                        <div class="flexchild machines">
                                            [[item.date]]
                                        </div>
                                        <div class="flexchild machines">
                                            [[item.provider]]
                                        </div>
                                        <span>
                                            $[[_toFixed(item.cost)]]
                                        </span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div> -->
                    <div class="row">
                        <div class="smaller">[[filterby.name]] tags</div>
                        <div class="list">
                            <template is="dom-repeat" items="{{report.group_by.tag}}">
                                <div class="flex-horizontal">
                                        <span class="name-col">
                                            [[_index(index)]].
                                            <span class="tag" hidden$="[[!item.name.length]]">[[item.name]]</span>
                                            <span hidden$="[[item.name.length]]">others</span>
                                        </span>
                                        <div class="flexchild machines">
                                            [[item.machine_count]] machines
                                        </div>
                                        <span>
                                            $[[_toFixed(item.cost)]]
                                        </span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </paper-material>

    </div>

    <iron-ajax id="getReport"
            method="GET"
            url="/api/v1/report"
            handle-as="json"
            loading="{{loadingData}}"
            on-response="handleResponse"
            on-error="handleError"
            params="{{timeParams}}" auto></iron-ajax>
    </template>
    <script>
        Polymer({

            is: 'page-insights',

            properties: {
                model: Object,
                sections: Array,
                onboarding: Object,
                largescreen: Boolean,
                report: {
                    type: Object,
                    value: {}
                },
                loadingData: {
                    type: Boolean,
                    value: true
                },
                params: {
                    type: Object,
                    computed: 'combineParams(timeParams.*, filterby.*)'
                },
                timeParams: {
                    type: Object,
                    value: {
                        window: "hour",
                        past: "0"
                    }
                },
                filterby: {
                    type: Object,
                    value: {
                        type: '',
                        name: ''
                    }
                },
                pastItems: Array,
                filterbyItems: Array,
                filterbyDisable: {
                    type: Boolean,
                    value: false
                },
                costData: {
                    type: Object,
                    value: {
                        labels: [],
                        datasets: [{
                            label: "cost",
                            backgroundColor: "rgba(120,120,120,0.2)",
                            borderColor: "rgba(120,120,120,1)",
                            borderWidth: 1,
                            pointBackgroundColor: "rgba(120,120,120,1)",
                            pointBorderColor: "#fff",
                            pointHoverBackgroundColor: "#fff",
                            pointHoverBorderColor: "rgba(120,120,120,1)",
                            data: []
                        }]
                    }
                },
                machinesData: {
                    type: Object,
                    value: {
                        labels: [],
                        datasets: [{
                            label: "machines",
                            backgroundColor: "rgba(120,120,120,0.2)",
                            borderColor: "rgba(120,120,120,1)",
                            borderWidth: 1,
                            pointBackgroundColor: "rgba(120,120,120,1)",
                            pointBorderColor: "#fff",
                            pointHoverBackgroundColor: "#fff",
                            pointHoverBorderColor: "rgba(120,120,120,1)",
                            data: []
                        }]
                    }
                },
                showRing: Boolean,
                showSecondList: Boolean,
                showFirstList: Boolean,
                ringTitle: String,
                firstListTitle: String,
                secondListTitle: String,
                costDrillData: {
                    type: Object,
                    value: {
                        labels: [],
                        datasets: [{
                            data: [],
                            backgroundColor: [
                                "#888888",
                                "#aaaaaa",
                                "#cccccc"
                            ],
                            hoverBackgroundColor: [
                                "#888888",
                                "#aaaaaa",
                                "#cccccc"
                            ]
                        }]
                    }
                },
                costDrillList: Array,
                costDrillList1: Array,
                costDrillList2: Array,
                graphWidth: {
                    type: String,
                    value: 600
                },
                doughnutWidth:{
                    type: String,
                    value: 300
                },
                machinesCount: {
                    type: Number,
                    computed: "computeMachinesCount(report)"
                }
            },
            listeners: {
                'resize' : 'updateChartWidth'
            },
            observers: [
                'computePastItems(timeParams.*)',
                'computeFilterbyItems(filterby.*, model.*)',
                'updateData(report.history)',
                'updateCostDrillData(report.group_by, filterby.name)'
            ],
            attached: function (e) {
                this.updateChartWidth(e);
            },
            computePastItems: function (timeParamsChangeRecord) {
                console.log("loadingData", this.loadingData);
                var items = [];
                if (this.timeParams.window == "hour") {
                    items.push({value: 0, text: "this hour"});
                    items.push({value: 1, text: "last hour"});
                    for (var i=2; i<11; i++) {
                        items.push({value: i, text: i + " hours ago"});
                    }
                }
                else if (this.timeParams.window == "day") {
                    items.push({value: 0, text: "today"});
                    items.push({value: 1, text: "yesterday"});
                    for (var i=2; i<11; i++) {
                        items.push({value: i, text: i + " days ago"});
                    }
                }
                else if (this.timeParams.window == "week") {
                    items = [{
                        value: '0',
                        text: 'this week'
                    },{
                        value: '1',
                        text: 'last week'
                    },{
                        value: '2',
                        text: 'two weeks ago'
                    },{
                        value: '3',
                        text: 'three weeks ago'
                    }]
                }
                else if (this.timeParams.window == "month") {
                    for (var i=0; i<12; i++){
                        var t = '';
                        if (i==0)
                            t = 'this month';
                        else if (i==1)
                            t = 'last month';
                        else
                            t = i+' months ago';

                        items.push({
                            value: i,
                            text: t
                        })
                    }
                }
                else if (this.timeParams.window == "quarter") {
                    items = [{
                        value: '0',
                        text: 'current quarter'
                    },{
                        value: '1',
                        text: 'previous quarter'
                    },{
                        value: '2',
                        text: '2 quarters ago'
                    },{
                        value: '3',
                        text: '3 quarters ago'
                    }]
                }

                this.set('pastItems',items);

                // if window changed reset selected past
                if (timeParamsChangeRecord.path == 'timeParams.window'){
                    this.set('timeParams.past', '0');
                    this.async(function(){
                        this.$.past.selected = -1;
                        this.$.past.selected = 0;
                    }, 100, this)
                }
            },
            computeFilterbyItems: function(filterby, model){
                var items = [];
                if (this.filterby.type == 'stack')
                    items = this.model.stacksArray;
                else if (this.filterby.type == 'cloud')
                    items = this.model.cloudsArray;
                else if (this.filterby.type == 'tag'){
                    var tags = this.model.machinesArray.filter(function(m){
                            return m.tags.length > 0
                        }).map(function(m){
                            for (var i=0; i < m.tags.length; i++){
                                return {
                                    'name': m.tags[i].key,
                                    'id': m.tags[i].key,
                                    'val': m.tags[i].val
                                };
                            }
                        });
                    var names = tags.map(function(t){
                        return t.name;
                    })
                    items = tags.filter(function(t, ind){
                        return names.indexOf(t.name) == ind;
                    });
                }
                else
                    items = [];

                if (!items.length){
                    this.set('filterbyDisable', true);
                }
                else {
                    this.set('filterbyDisable', false);
                }

                this.set('filterbyItems',items);

                // if filterby changed reset selected item
                if (filterby.path == 'filterby.type'){
                    this.set('filterby.name', '');
                    this.async(function(){
                        this.$.filterbyName.selected = '';
                    }, 100, this)
                }
            },
            updateData: function (history) {
                var costData = [],
                    machinesData = [],
                    labels = [];
                if (history){
                    labels = history.map(function(datapoint){
                        return moment(datapoint.date).format('YYYY-MM-DD').toString();
                    });
                    costData = history.map(function(datapoint){
                        return datapoint.cost_per_month;
                    });
                    machinesData = history.map(function(datapoint){
                        return datapoint.machine_count;
                    });
                }

                this.set('costData.datasets.0.data', costData);
                this.set('costData.labels', labels);
                this.set('machinesData.datasets.0.data', machinesData);
                this.set('machinesData.labels', labels);

                this.$.costgraph.updateChart();
                this.$.machinesgraph.updateChart();
            },
            updateCostDrillData: function(groupby, filterbyname) {
                var drillData = [],
                    drillLabels = [],
                    drill, //Array
                    drillList1, //String
                    drillList2; //String

                // show all categories when no filterby set : clouds in ring / stacks list / tags list
                // show stacks in ring + tags list if filterby cloud
                // show clouds in ring + tags list if filterby stack
                // show clouds in ring + stacks in list if filterby tag

                var dataMap = Object.keys(this.report.group_by),
                    key;
                if (this.filterby.type == '' || (this.filterby.type == "tag" && this.report.group_by['tag'])) {
                    drill = groupby['cloud'] || groupby['stack'] || groupby['tag'];

                    if (groupby['cloud'])       { key = 'cloud' }
                    else if (groupby['stack'])  { key = 'stack' }
                    else if (groupby['tag'])    { key = 'tag' }

                    dataMap.splice(dataMap.indexOf(key), 1);
                    
                    if (dataMap.length > 0 ) 
                        drillList1 = dataMap[0];
                    
                    if (dataMap.length > 1 )
                        drillList2 = dataMap[1];
                }
                else if (this.filterby.type == 'stack' || this.filterby.type == "cloud") {
                    drill = this.filterby.type == 'stack' ? groupby['cloud'] : groupby['stack'];
                    key =  this.filterby.type == 'stack' ? 'cloud' : 'stack';

                    dataMap.splice(dataMap.indexOf(key), 1);

                    if (dataMap.length)
                        drillList1 = dataMap[0];
                }
                
                console.log("dataMap", this.filterby.type, dataMap, drillList1, drillList2);

                if (drill){
                    this.set('showRing', true);
                    drillData = drill.map(function(point){
                        return this._toFixed(point.cost);
                    }, this);
                    drillLabels = drill.map(function(point){
                        return point.name.length ? point.name : 'untagged';
                    });
                }
                else {
                    this.set('showRing', false);
                }

                // fill in ring
                this.set('costDrillData.datasets.0.data', drillData);
                this.set('costDrillData.labels', drillLabels);
                this.set('costDrillList', drill ? drill.sort(function(a,b){ return a.cost < b.cost}) : []);

                // fill in first list
                if (drillList1 && drillList1.length) {
                    this.set('showFirstList', true);
                    this.set('costDrillList1', this.report.group_by[drillList1] ? this.report.group_by[drillList1].sort(function(a,b){ return a.cost < b.cost}) : [])
                }
                else {
                    this.set('showFirstList', false);
                }

                // fill in second list if needed
                if (drillList2 && drillList2.length){
                    this.set('showSecondList', true);
                    this.set('costDrillList2', this.report.group_by[drillList2] ? this.report.group_by[drillList2].sort(function(a,b){ return a.cost < b.cost}) : [])
                }
                else {
                    this.set('showSecondList', false);
                }

                this.$.drillcostgraph.updateChart();
            },
            updateChartWidth: function(e) {
                var parentWidth = this.$.graphRow.offsetWidth;
                if (parentWidth > 800){
                    this.set('graphWidth', (parentWidth-50)/2);
                    this.set('doughnutWidth', Math.min((parentWidth-50)/4, 220));
                }
                else {
                    this.set('graphWidth', parentWidth-50);
                    this.set('doughnutWidth', Math.min((parentWidth-50)/4, 220));
                }
                this.resizeGraphs();
                var that = this;
                this.debounce('resizer', function(){
                    console.log('resized chart');
                    that.resizeGraphs();
                }, 500)
            },
            resizeGraphs: function(){
                console.log('resizeGraphs');
                this.$.costgraph.resize();
                this.$.drillcostgraph.resize()
            },
            combineParams: function(time, filter) {
                console.log(time, filter)
                if (this.timeParams.window && this.timeParams.past)
                    return {
                        window: this.timeParams.window,
                        past: this.timeParams.past,
                        // type: this.filterBy.type,
                        // name: this.filterBy.name
                    }
            }, 
            handleResponse: function(e) {
                console.log('handleResponse', e);
                // this.$.getReport.removeAttribute('auto');
                if (e.detail.xhr.response)
                    this.set('report', e.detail.xhr.response)
            },
            handleError: function(e){
                console.log('handleError', e);
            },
            _toFixed: function(inp) {
                return parseFloat(inp).toFixed(2) != "NaN" ? parseFloat(inp).toFixed(2) : '';
            },
            _index: function(ind) {
                return ind+1;
            },
            computeMachinesCount: function(report) {
                var count = 0;
                if (report && report.group_by && report.group_by.cloud) {
                    count = this.report.group_by.cloud.map(function(c){
                                return c.machine_count;
                            }).reduce(function(a,b){
                                return a+b;
                            });
                }
                return count;
            }
        });

        (function() {
            var throttle = function(type, name, obj) {
                obj = obj || window;
                var running = false;
                var func = function() {
                    if (running) { return; }
                    running = true;
                     requestAnimationFrame(function() {
                        obj.dispatchEvent(new CustomEvent(name));
                        running = false;
                    });
                };
                obj.addEventListener(type, func);
            };

            /* init - you can init any event */
            // throttle("resize", "optimizedResize");
        })();

        // handle event
        window.addEventListener("optimizedResize", function() {
            document.querySelector('page-insights').fire('resize')
        });

    </script>
</dom-module>
