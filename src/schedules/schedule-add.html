<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<link rel="import" href="../app-form/app-form.html">

<dom-module id="schedule-add">
    <template>
        <style is="custom-style" include="forms"></style>
        <style is="custom-style" include="single-page"></style>
        <style include="shared-styles">
        :host {
            display: block;
        }
        
        #content {
            max-width: 900px;
        }
        
        paper-material {
            display: block;
            padding: 24px;
        }
        
        paper-progress {
            position: absolute;
            bottom: 85px;
            width: 100%;
            left: 0;
            right: 0;
        }
        app-form::content #schedule_entry_interval_period {
            width: 70px;
        }
        </style>
        <div id="content">
            <paper-material class="single-head layout horizontal" style$="background-color: [[section.color]]">
                <span class="icon"><iron-icon icon="[[section.icon]]"></iron-icon></span>
                <div class="title flex">
                    <h2>
                        Add Schedule
                    </h2>
                    <div class="subtitle">
                    </div>
                </div>
            </paper-material>
            <paper-material>
                <app-form id="scheduleAddForm" fields="{{fields}}" form="[[schedule]]" url="/api/v1/schedules" on-response="_handleAddScheduleResponse" on-error="_handleError"></app-form>
            </paper-material>
        </div>
    </template>
    <script>
SCHEDULEACTIONS = {
  'reboot': {
    'name': 'reboot',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'start': {
    'name': 'start',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'stop': {
    'name': 'stop',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'suspend': {
    'name': 'suspend',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'resume': {
    'name': 'resume',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'undefine': {
    'name': 'undefine',
    'icon': 'image:panorama-fish-eye',
    'confirm': true,
    'multi': true
  },
  'destroy': {
    'name': 'destroy',
    'icon': 'delete',
    'confirm': true,
    'multi': true
  },
  'run-script': {
    'name': 'run script',
    'icon': 'image:movie-creation',
    'confirm': true,
    'multi': false
  }
};
        Polymer({
            is: 'schedule-add',

            properties: {
                section: Object,
                model: Object,
                schedule: Object,
                fields: {
                    type: Array,
                    value: [{
                        name: "name",
                        label: "Name *",
                        type: "text",
                        value: "",
                        defaultValue: "",
                        placeholder: "",
                        errorMessage: "Please enter schedule's name.",
                        show: true,
                        required: true,
                        helptext: ""                    
                    }, {
                        name: "description",
                        label: "Description",
                        type: "text",
                        value: "",
                        defaultValue: "",
                        placeholder: "",
                        show: true,
                        required: false,
                        helptext: "Optional. Helpful descriptions improve a team's workflows."
                    }, {
                        name: "task_enabled",
                        label: "Enabled",
                        type: "toggle",
                        value: true,
                        defaultValue: true,
                        show: true,
                        required: false,
                        helptext: "You can save your schedule and enable it later."
                    }, {
                        name: "action",
                        label: "Task",
                        type: "dropdown",
                        value: "",
                        defaultValue: "",
                        show: true,
                        required: false,
                        helptext: "Choose one from the available tasks to schedule.",
                        options: [],
                    }, {
                        name: "script_id",
                        label: "Script",
                        type: "mist_dropdown",
                        value: "",
                        defaultValue: "",
                        add: true,
                        show: false,
                        required: false,
                        helptext: "Schedule an existing script to run.",
                        options: [],
                        showIf: {
                            fieldName: "action",
                            fieldValues: ["run script"]
                        }
                    }, {
                        name: "params",
                        label: "Parameters",
                        type: "textarea",
                        value: "",
                        defaultValue: "",
                        helptext: "",
                        show: false,
                        required: false,
                        showIf: {
                            fieldName: "action",
                            fieldValues: ["run script"]
                        }                    
                    }, {
                        name: "ids_or_tags",
                        label: "Specific machines or machines with tags",
                        type: "radio",
                        value: "tags",
                        defaultValue: "tags",
                        show: true,
                        required: false,
                        excludeFromPayload: true,
                        helptext: "The scheduled task can run either on specific machines, or on machines with the specified tags at the scheduled time",
                        class: "bind-bottom radio-highight",
                        options: [{
                            title: "Specific Machines",
                            val: "ids"
                        },{
                            title: "Machines with tags",
                            val: "tags"
                        }]
                    }, {
                        name: "machines_uuids",
                        label: "Machines",
                        // type: "mist_dropdown",
                        type: "checkboxes",
                        value: "",
                        defaultValue: "",
                        show: true,
                        required: true,
                        excludeFromPayload: true,
                        helptext: "Select specific machines to be included in scheduler.",
                        options: [],
                        class: "bind-top background",
                        showIf: {
                            fieldName: "ids_or_tags",
                            fieldValues: ["ids"]
                        }
                    }, {
                        name: "machines_tags",
                        label: "Machines with tags",
                        type: "textarea",
                        value: "",
                        defaultValue: "",
                        show: true,
                        required: true,
                        excludeFromPayload: false,
                        helptext: "Scheduler will include all machines with the specified tags. Tag's keys can only be defined. Alphanumerical only.",
                        class: "bind-top background",
                        showIf: {
                            fieldName: "ids_or_tags",
                            fieldValues: ["tags"]
                        }
                    }, {
                        name: "schedule_type",
                        label: "Schedule Type",
                        type: "radio",
                        value: "one_off",
                        defaultValue: "interval",
                        helptext: "The scheduler type. Visit the docs ",
                        helpHref: "http://docs.mist.io/article/118-running-scheduled-tasks-cronjobs-with-mist-io",
                        show: true,
                        required: true,
                        class: "bind-bottom radio-highight",
                        options: [{
                            title: "Once",
                            val: "one_off"
                        },{
                            title: "Repeat",
                            val: "interval"
                        }, {
                            title: "Crontab",
                            val: "crontab"
                        }]
                    }, {
                        name: "schedule_entry",
                        label: "Schedule time",
                        type: "text",
                        value: {every: 10, period: "minutes"},
                        defaultValue: "",
                        helptext: "",
                        show: false,
                        required: true
                    }, {
                        name: "schedule_entry_interval_every",
                        label: "Interval",
                        type: "text",
                        value: "10",
                        defaultValue: "",
                        excludeFromPayload: true,
                        class: "bind-both background",
                        show: true,
                        required: true,
                        helptext: "Example, every 10 minutes",
                        showIf: {
                            fieldName: "schedule_type",
                            fieldValues: ["interval"]
                        }
                    }, {
                        name: "schedule_entry_interval_period",
                        type: "radio",
                        value: "minutes",
                        defaultValue: "minutes",
                        excludeFromPayload: true,
                        class: "bind-top background",
                        show: true,
                        required: false,
                        showIf: {
                            fieldName: "schedule_type",
                            fieldValues: ["interval"]
                        },
                        options: [{ //days, hours, minutes, seconds, microseconds
                            title: "days",
                            val: "days"
                        },{
                            title: "hours",
                            val: "hours"
                        },{
                            title: "mins",
                            val: "minutes"
                        },{
                            title: "secs",
                            val: "seconds"
                        }]
                    }, {
                        name: "schedule_entry_crontab",
                        label: "Crontab",
                        type: "text",
                        value: "*/10 * * * *",
                        defaultValue: "",
                        helptext: "",
                        excludeFromPayload: true,
                        class: "bind-top background",
                        show: true,
                        required: false,
                        helptext: "Example: */10 * * 1 *, is every 10 minutes on the 1st of each month. Relative periods: minute hour day_of_week day_of_month month_of_year.",
                        helpHref: "http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html#crontab-schedules",
                        showIf: {
                            fieldName: "schedule_type",
                            fieldValues: ["crontab"]
                        }
                    }, {
                        name: "schedule_entry_one_off",
                        label: "",
                        type: "date",
                        value: "",
                        defaultValue: "",
                        class: "bind-top background",
                        icon: "schedule",
                        excludeFromPayload: true,
                        show: true,
                        required: false,
                        showIf: {
                            fieldName: "schedule_type",
                            fieldValues: ["one_off"]
                        }
                    }, {
                        name: "expires",
                        label: "Expires",
                        type: "date",
                        value: "",
                        placeholder: "never",
                        excludeFromPayload: true,
                        defaultValue: "",                        
                        helptext: "",
                        icon: "schedule",
                        show: true,
                        required: false,
                        disabled: true,
                        showIf: {
                            fieldName: "schedule_type",
                            fieldValues: ["interval", "crontab"]
                        }
                    }, {
                        name: "max_run_count",
                        label: "Maximum Run Count",
                        type: "text",
                        value: "",
                        defaultValue: "",
                        excludeFromPayload: true,
                        disabled: true,
                        show: true,
                        required: false,
                        helptext: "Optional. Integers only. Define a maximum run count, unless it's an one_of schedule.",
                        showIf: {
                            fieldName: "schedule_type",
                            fieldValues: ["interval", "crontab"]
                        }
                    },{
                        name: "run_immediately",
                        label: "Run once immediately",
                        type: "toggle",
                        value: false,
                        defaultValue: false,
                        show: true,
                        required: false,
                        helptext: "Set to true to run the scheduled task once upon creation and then as scheduled."
                    }],
                    notify: true
                },
                actions: {
                    type: Array,
                    computed: "_computeActions(model.machinesArray)"
                }
            },
            observers: [
                '_fieldsChanged(fields.*)',
                '_updateFields(fields, model.*)'
            ],
            listeners: {
                'add-input': 'addInput'
            },
            _computeActions: function(machinesArray) {
                var ret = ['start', 'stop', 'suspend', 'reboot', 'resume', 'destroy', 'run-script'];
                
                var actions = [];
                for (var i = 0; i < ret.length; i++) {
                    var act = SCHEDULEACTIONS[ret[i]];
                    var transformRet = { 
                        title: act.name.toUpperCase(), 
                        val: act.name, 
                        icon: act.icon 
                    };
                    actions.push(transformRet);
                }

                return actions;
            },
            _atLeastOne: function(action) {
                return this.model.machinesArray.find(function(m){
                    return m[action];
                });
            },
            _updateFields: function(fields, model){
                if (this.model && this.fields) {
                    this.fields.forEach(function(f, index) {
                        if (f.name  == "script_id") {
                            f.options = this.model.scriptsArray || [];
                        }

                        if (f.name  == "machines_uuids") {
                            f.options = this.model.machinesArray || [];
                        }

                        if (f.name.startsWith("action")) {
                            f.options = this.actions;
                        }
                    }, this);
                }
            },
            _fieldsChanged: function(changeRecord){
                // console.log('changeRecord', changeRecord);
                if (changeRecord.path.endsWith('.value')) {
                    // selecting action or script
                    if (this.get(changeRecord.path.replace('.value','')).name == "script_or_action"){
                        
                        // var actionInd = this._fieldIndexByName("action");
                        // var scriptInd = this._fieldIndexByName("script_id");

                        // if (changeRecord.value == "action") {
                        //     this.set('fields.'+ scriptInd +'.excludeFromPayload', true);
                        //     this.set('fields.'+ actionInd +'.excludeFromPayload', false);
                        // }
                        // else if (changeRecord.value == "script") {
                        //     this.set('fields.'+ actionInd +'.excludeFromPayload', true);
                        //     this.set('fields.'+ scriptInd +'.excludeFromPayload', false);
                        // }
                        // console.log("SCRIPT:", !this.get('fields.'+ scriptInd +'.excludeFromPayload'), " ACTION:", !this.get('fields.'+ tagstInd +'.excludeFromPayload'))
                    }

                    // selecting action
                    if (this.get(changeRecord.path.replace('.value','')).name == "action" ){
                        var actionInd = this._fieldIndexByName("action"),
                            scriptInd = this._fieldIndexByName("script_id");
                        if (changeRecord.value == "run script"){
                            this.set('fields.'+ actionInd +'.excludeFromPayload', true);
                            this.set('fields.'+ scriptInd +'.excludeFromPayload', false);
                        }
                        if (changeRecord.value != "run script"){
                            this.set('fields.'+ actionInd +'.excludeFromPayload', false);
                            this.set('fields.'+ scriptInd +'.excludeFromPayload', true);
                        }
                    }

                    // selecting uuids or tags
                    if (this.get(changeRecord.path.replace('.value','')).name == "ids_or_tags"){

                        var uuidsInd = this._fieldIndexByName("machines_uuids");
                        var tagstInd = this._fieldIndexByName("machines_tags");

                        if (changeRecord.value == "ids") {
                            this.set('fields.'+ uuidsInd +'.excludeFromPayload', false);
                            this.set('fields.'+ tagstInd +'.excludeFromPayload', true);
                        }
                        else if (changeRecord.value == "tags") {
                            this.set('fields.'+ uuidsInd +'.excludeFromPayload', true);
                            this.set('fields.'+ tagstInd +'.excludeFromPayload', false);

                            // clear checkbox selection
                            this.set('fields.'+ uuidsInd +'.value', []);
                            var checkboxes = this.$.scheduleAddForm.querySelectorAll('paper-checkbox');
                            [].forEach.call(checkboxes, function(el, index) {
                                el.checked = false;
                            });
                        }
                    }

                    // initial values in shedule entry
                    if (this.get(changeRecord.path.replace('.value','')).name == "schedule_type"){
                        var entryInd = this._fieldIndexByName("schedule_entry"),
                            expInd = this._fieldIndexByName("expires"),
                            entryCronTabInd = this._fieldIndexByName("schedule_entry_crontab"),
                            maxcountInd = this._fieldIndexByName("max_run_count"),
                            entry;
                        if (changeRecord.value == "interval") {
                            entry = this._processInterval();
                            this.set('fields.'+ expInd +'.disabled', false);
                            this.set('fields.'+ maxcountInd +'.disabled', false);
                            this.set('fields.'+ maxcountInd +'.value', "");
                        }
                        else if (changeRecord.value == "crontab") {
                            entry = this._processCrotab(this.get('fields.'+entryCronTabInd+'.value'));
                            this.set('fields.'+ expInd +'.disabled', false);
                            this.set('fields.'+ maxcountInd +'.disabled', false);
                            this.set('fields.'+ maxcountInd +'.value', "");
                        }
                        else if (changeRecord.value == "one_off") {
                            entry = "";
                            this.set('fields.'+ expInd +'.disabled', true);
                            this.set('fields.'+ maxcountInd +'.value', 1);
                            this.set('fields.'+ maxcountInd +'.disabled', true);
                        }
                        this.set('fields.'+ entryInd +'.value', entry);
                    }

                    // date in shedule entry
                    if (this.get(changeRecord.path.replace('.value','')).name == "schedule_entry_one_off"){
                        var entryInd = this._fieldIndexByName("schedule_entry");
                        this.set('fields.'+ entryInd +'.value', changeRecord.value);
                    }

                    // crontab in schedule entry
                    if (this.get(changeRecord.path.replace('.value','')).name == "schedule_entry_crontab"){
                        var entryInd = this._fieldIndexByName("schedule_entry");
                        this.set('fields.'+ entryInd +'.value', this._processCrotab(changeRecord.value));
                    }

                    // interval changes in schedule entry
                    if (this.get(changeRecord.path.replace('.value','')).name.startsWith("schedule_entry_interval_")) {
                        var entryInd = this._fieldIndexByName("schedule_entry");
                        this.set('fields.'+ entryInd +'.value', this._processInterval());                        
                    }

                    if (this.get(changeRecord.path.replace('.value','')).name == "expires"){
                        var expiresInd = this._fieldIndexByName("expires");
                        var include = changeRecord.value != "" ? false : true;
                        this.set('fields.'+ expiresInd +'.excludeFromPayload', include);
                    }

                    if (this.get(changeRecord.path.replace('.value','')).name == "max_run_count"){
                        var maxcountInd = this._fieldIndexByName("max_run_count");
                        if (typeof(this.get('fields.'+ maxcountInd +'.value')) != 'number'){
                                if (parseInt(changeRecord.value) == NaN){
                                    this.set('fields.'+ maxcountInd +'.excludeFromPayload', true);
                                    this.set('fields.'+ maxcountInd +'.value', "");
                                }
                                else {
                                    this.set('fields.'+ maxcountInd +'.excludeFromPayload', false);
                                    this.set('fields.'+ maxcountInd +'.value', parseInt(changeRecord.value));
                                }
                        }
                    }
                }
            },
            _processInterval: function() {
                var everyInd = this._fieldIndexByName("schedule_entry_interval_every");
                var periodInd = this._fieldIndexByName("schedule_entry_interval_period");

                var interval = {'every':this.get('fields.'+ everyInd +'.value'), 'period': this.get('fields.'+ periodInd +'.value')};
                    
                return interval;
            },
            _processCrotab: function(entry) {
                var chunchs = entry.split(" ");
                // "minute" : "30", "hour" : "2", "day_of_week" : "*", "day_of_month" : "*", "month_of_year" : "*"
                // fill in missing 
                for (var i = 0; i < 5; i++) {
                    if (!chunchs[i])
                        chunchs[i] = "*"
                }
                var construct = {
                        'minute': chunchs[0],
                        'hour': chunchs[1],
                        'day_of_week': chunchs[2],
                        'day_of_month': chunchs[3],
                        'month_of_year': chunchs[4]
                    };
                return construct;
            },
            _handleAddScheduleResponse: function(e){
                var response = YAML.parse(e.detail.xhr.response);
                this.async(function(){
                    document.querySelector('app-location').set('path', '/schedules/' + response.id);
                }, 500)
            },
            _handleError: function(e) {
                console.log(e);
                this.$.errormsg.textContent = e.detail.request.xhr.responseText;
                this.set('formError', true);
            },
            _fieldIndexByName: function(name){
                var index;
                var passField = this.fields.find(function(f, ind){
                    index = ind;
                    return f.name == name;
                });
                return index;
            },
            _goBack: function() {
                history.back();
            },
            updateScripts: function(e){
                console.log('updateScripts', e)
                var scriptInd = this._fieldIndexByName("script_id");
                this.async(function(){
                    this.set('fields.'+ scriptInd +'.options', this.model.scriptsArray);
                    this.set('fields.'+ scriptInd +'.value', e.detail.script);
                }.bind(this), 1000);
            },
            addInput: function(e){
                if (e.detail.fieldname == 'script_id'){
                    //set attribute origin
                    var origin = window.location.pathname;
                    var qParams = {
                        'origin': origin
                    }
                    document.querySelector('app-location').set('path', '/scripts/+add');
                    document.querySelector('app-location').set('queryParams', qParams);
                }
            },
        });
    </script>
</dom-module>
