<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<link rel="import" href="../app-form/app-form.html">

<dom-module id="schedule-add">
    <template>
        <style is="custom-style" include="forms"></style>
        <style is="custom-style" include="single-page"></style>
        <style include="shared-styles">
        :host {
            display: block;
        }
        
        #content {
            max-width: 900px;
        }
        
        paper-material {
            display: block;
            padding: 24px;
        }
        
        paper-progress {
            position: absolute;
            bottom: 85px;
            width: 100%;
            left: 0;
            right: 0;
        }
        
        :host >::content paper-input-container {
            padding-top: 16px;
            padding-bottom: 16px;
        }
        </style>
        <div id="content">
            <paper-material class="single-head layout horizontal" style$="background-color: [[section.color]]">
                <span class="icon"><iron-icon icon="[[section.icon]]"></iron-icon></span>
                <div class="title flex">
                    <h2>
                        Add Schedule
                    </h2>
                    <div class="subtitle">
                    </div>
                </div>
            </paper-material>
            <paper-material>
                <app-form fields="{{fields}}" form="[[schedule]]" url="/api/v1/schedules" on-response="_handleAddScheduleResponse" on-error="_handleError"></app-form>
            </paper-material>
        </div>
    </template>
    <script>
SCHEDULEACTIONS = {
  'reboot': {
    'name': 'reboot',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'start': {
    'name': 'start',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'stop': {
    'name': 'stop',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'suspend': {
    'name': 'suspend',
    'icon': 'av:stop',
    'confirm': true,
    'multi': true
  },
  'resume': {
    'name': 'resume',
    'icon': 'av:replay',
    'confirm': true,
    'multi': true
  },
  'undefine': {
    'name': 'undefine',
    'icon': 'image:panorama-fish-eye',
    'confirm': true,
    'multi': true
  },
  'destroy': {
    'name': 'destroy',
    'icon': 'delete',
    'confirm': true,
    'multi': true
  }
};
        Polymer({
            is: 'schedule-add',

            properties: {
                section: Object,
                model: Object,
                schedule: Object,
                fields: {
                    type: Array,
                    value: [{
                        name: "name",
                        label: "Name *",
                        type: "text",
                        value: "",
                        defaultValue: "",
                        placeholder: "",
                        errorMessage: "Please enter schedule's name.",
                        show: true,
                        required: true,
                        helptext: ""                    
                    }, {
                        name: "description",
                        label: "Description",
                        type: "text",
                        value: "",
                        defaultValue: "",
                        placeholder: "",
                        show: true,
                        required: false,
                        helptext: "Optional. Helpful descriptions improve a team's workflows."
                    }, {
                        name: "enabled",
                        label: "Enabled",
                        type: "toggle",
                        value: true,
                        defaultValue: true,
                        show: true,
                        required: true,
                        helptext: "You can save your schedule and enable it later."
                    }, {
                        name: "script_or_action",
                        label: "Scheduler task",
                        type: "radio",
                        value: "script",
                        defaultValue: "script",
                        helptext: "The scheduler can either perform an action or run a script",
                        show: true,
                        required: true,
                        excludeFromPayload: true,
                        class: "bind-bottom radio-highight",
                        options: [{
                            title: "Perform an action",
                            val: "action"
                        },{
                            title: "Run a script",
                            val: "script"
                        }]
                    }, {
                        name: "script_id",
                        label: "Script",
                        type: "mist_dropdown",
                        value: "",
                        add: true,
                        defaultValue: "",
                        show: false,
                        required: false,
                        helptext: "Schedule an existing script to run.",
                        options: [],
                        class: "bind-top background",
                        showIf: {
                            fieldName: "script_or_action",
                            fieldValues: ["script"]
                        }
                    }, {
                        name: "action",
                        label: "Action",
                        type: "dropdown",
                        value: "",
                        defaultValue: "",
                        show: false,
                        required: false,
                        helptext: "Schedule a machine action to be performed.",
                        options: [],
                        class: "bind-top background",
                        showIf: {
                            fieldName: "script_or_action",
                            fieldValues: ["action"]
                        }
                    }, {
                        name: "ids_or_tags",
                        label: "Specific machines or machines with tags",
                        type: "radio",
                        value: "tags",
                        defaultValue: "tags",
                        show: true,
                        required: false,
                        excludeFromPayload: true,
                        helptext: "The scheduled task can run either on specific machines, or on machines with the specified tags at the scheduled time",
                        class: "bind-bottom radio-highight",
                        options: [{
                            title: "Specific Machines",
                            val: "ids"
                        },{
                            title: "Machines with tags",
                            val: "tags"
                        }]
                    }, {
                        name: "machines_uuids",
                        label: "Machines",
                        type: "mist_dropdown",
                        // type: "checkboxes",
                        value: "",
                        defaultValue: "",
                        show: true,
                        required: true,
                        excludeFromPayload: false,
                        helptext: "Select specific machines to be included in scheduler.",
                        options: [],
                        class: "bind-top background",
                        showIf: {
                            fieldName: "ids_or_tags",
                            fieldValues: ["ids"]
                        }
                    }, {
                        name: "machines_tags",
                        label: "Machines with tags",
                        type: "textarea",
                        value: "",
                        defaultValue: "",
                        show: true,
                        required: true,
                        excludeFromPayload: false,
                        helptext: "Scheduler will include all machines with the specified tags.",
                        class: "bind-top background",
                        showIf: {
                            fieldName: "ids_or_tags",
                            fieldValues: ["tags"]
                        }
                    }, {
                        name: "schedule_type",
                        label: "Schedule Type",
                        type: "radio",
                        value: "interval",
                        defaultValue: "interval",
                        helptext: "Choose the scheduler type. Read more on the docs ",
                        helpHref: "http://docs.mist.io/article/118-running-scheduled-tasks-cronjobs-with-mist-io",
                        show: true,
                        required: true,
                        class: "bind-bottom radio-highight",
                        options: [{
                            title: "Interval",
                            val: "interval"
                        }, {
                            title: "Crontab",
                            val: "crontab"
                        }, {
                            title: "One off",
                            val: "one_off"
                        }]
                    }, {
                        name: "schedule_entry",
                        label: "Schedule time",
                        type: "text",
                        value: "",
                        defaultValue: "",
                        helptext: "",
                        show: false,
                        required: true
                    }, {
                        name: "schedule_entry_interval",
                        label: "Interval",
                        type: "text",
                        value: '{"every" : 10, "period" : "minutes"}',
                        defaultValue: "",
                        excludeFromPayload: true,
                        placeholder: 'eg: {"every" : 10, "period" : "minutes"}',
                        helptext: "",
                        class: "bind-both background",
                        show: true,
                        required: false,
                        showIf: {
                            fieldName: "schedule_type",
                            fieldValues: ["interval"]
                        }
                    }, {
                        name: "schedule_entry_crontab",
                        label: "Crontab",
                        type: "text",
                        value: '{"minute": "*/5"}',
                        defaultValue: "",
                        placeholder: 'eg: {"minute": "*/5"}',
                        helptext: "",
                        excludeFromPayload: true,
                        class: "bind-both background",
                        show: true,
                        required: false,
                        showIf: {
                            fieldName: "schedule_type",
                            fieldValues: ["crontab"]
                        }
                    }, {
                        name: "schedule_entry_one_off",
                        label: "Date",
                        type: "date",
                        value: "Select",
                        defaultValue: "",
                        class: "bind-both background",
                        icon: "schedule",
                        excludeFromPayload: true,
                        show: true,
                        required: false,
                        showIf: {
                            fieldName: "schedule_type",
                            fieldValues: ["one_off"]
                        }
                    }, {
                        name: "params",
                        label: "Parameters",
                        type: "textarea",
                        value: "",
                        defaultValue: "",
                        helptext: "",
                        show: true,
                        class: "bind-top background",
                        required: false
                    }, {
                        name: "expires",
                        label: "Expires",
                        type: "date",
                        value: "",
                        excludeFromPayload: true,
                        defaultValue: "",
                        helptext: "",
                        icon: "schedule",
                        show: true,
                        required: false
                    }, {
                        name: "run_immediately",
                        label: "Run once immediately",
                        type: "toggle",
                        value: false,
                        defaultValue: false,
                        show: true,
                        required: false,
                        helptext: "Set to true to run the scheduled task once upon creation and then as scheduled."
                    }],
                    notify: true
                },
                actions: {
                    type: Array,
                    computed: "_computeActions(model.machinesArray)"
                }
            },
            observers: [
                '_fieldsChanged(fields.*)',
                '_updateFields(model.*)'
            ],
            listeners: {
            },
            _computeActions: function(machinesArray) {
                var ret = ['start', 'stop', 'suspend', 'reboot', 'resume', 'destroy'];
                
                var actions = [];
                for (var i = 0; i < ret.length; i++) {
                    var act = SCHEDULEACTIONS[ret[i]];
                    var transformRet = { 
                        title: act.name.toUpperCase(), 
                        val: act.name, 
                        icon: act.icon 
                    };
                    actions.push(transformRet);
                }

                return actions;
            },
            _atLeastOne: function(action) {
                return this.model.machinesArray.find(function(m){
                    return m[action];
                });
            },
            _updateFields: function(model){
                this.fields.forEach(function(f, index) {
                    if (f.name  == "script_id") {
                        f.options = this.model.scriptsArray;
                    }

                    if (f.name  == "machines_uuids") {
                        f.options = this.model.machinesArray;
                    }

                    if (f.name.startsWith("action")) {
                        f.options = this.actions;
                    }
                }, this);
            },
            _fieldsChanged: function(changeRecord){
                console.log('changeRecord', changeRecord);

                // selecting action or script
                if (changeRecord.path.endsWith('.value') && this.get(changeRecord.path.replace('.value','')).name == "script_or_action"){
                    
                    var actionInd = this._fieldIndexByName("action");
                    var scriptInd = this._fieldIndexByName("script_id");

                    if (changeRecord.value == "action") {
                        this.set('fields.'+ scriptInd +'.excludeFromPayload', true);
                        this.set('fields.'+ actionInd +'.excludeFromPayload', false);
                    }
                    else if (changeRecord.value == "script") {
                        this.set('fields.'+ actionInd +'.excludeFromPayload', true);
                        this.set('fields.'+ scriptInd +'.excludeFromPayload', false);
                    }
                    // console.log("SCRIPT:", !this.get('fields.'+ scriptInd +'.excludeFromPayload'), " ACTION:", !this.get('fields.'+ tagstInd +'.excludeFromPayload'))
                }

                // selecting uuids or tags
                if (changeRecord.path.endsWith('.value') && this.get(changeRecord.path.replace('.value','')).name == "ids_or_tags"){

                    var uuidsInd = this._fieldIndexByName("machines_uuids");
                    var tagstInd = this._fieldIndexByName("machines_tags");

                    if (changeRecord.value == "ids") {
                        this.set('fields.'+ uuidsInd +'.excludeFromPayload', false);
                        this.set('fields.'+ tagstInd +'.excludeFromPayload', true);
                    }
                    else if (changeRecord.value == "tags") {
                        this.set('fields.'+ uuidsInd +'.excludeFromPayload', true);
                        this.set('fields.'+ tagstInd +'.excludeFromPayload', false);
                    }
                    // console.log("UUIDS:", !this.get('fields.'+ uuidsInd +'.excludeFromPayload'), " TAGS:", !this.get('fields.'+ tagstInd +'.excludeFromPayload'))
                }

                if (changeRecord.path.endsWith('.value') && this.get(changeRecord.path.replace('.value','')).name.startsWith("schedule_entry_")){
                    var entryInd = this._fieldIndexByName("schedule_entry");
                    this.set('fields.'+ entryInd +'.value', changeRecord.value);
                }

                if (changeRecord.path.endsWith('.value') && this.get(changeRecord.path.replace('.value','')).name == "expires"){
                    var expiresInd = this._fieldIndexByName("expires");
                    var include = changeRecord.value != "" ? false : true;
                    this.set('fields.'+ expiresInd +'.excludeFromPayload', include);
                }
            },
            updatePayload: function(fields){
                // test code: hardcoded data for testing
                // var payload = {
                //     script_id: "beca93f47e334929a8cb2a489a856ac5",
                //     action: "",
                //     machines_uuids: ['030da16913a04e0e93a3a54bc420be1b'],
                //     machines_tags: [],
                //     name: schedName,
                //     enabled: true,
                //     run_immediately: true,
                //     expires: "2016-12-20 17:20:00",
                //     description: "",
                //     schedule_type: "crontab",
                //     schedule_entry: '{"minute": "*/5"}',
                //     params: ""
                // };
                // this.set('schedule', payload);
                // schedule_entry: {date: '2017-3-24 17:20:00'},
            },
            _handleAddScheduleResponse: function(e){
                var response = YAML.parse(e.detail.xhr.response);
                document.querySelector('app-location').set('path', '/schedules/' + response.id);
            },
            _handleError: function(e) {
                console.log(e);
                this.$.errormsg.textContent = e.detail.request.xhr.responseText;
                this.set('formError', true);
            },
            _fieldIndexByName: function(name){
                var index;
                var passField = this.fields.find(function(f, ind){
                    index = ind;
                    return f.name == name;
                });
                return index;
            },
            _goBack: function() {
                history.back();
            }
        });
    </script>
</dom-module>
