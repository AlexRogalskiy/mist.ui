<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/mist-list/mist-list.html">

<link rel="import" href="teams/team-page.html">
<link rel="import" href="teams/member-page.html">
<link rel="import" href="teams/members-add.html">
<link rel="import" href="teams/member-add-in-teams.html">

<link rel="import" href="page-items.html">

<dom-module id="page-teams">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <app-route route="{{route}}"
                pattern="/:team"
                data="{{data}}"></app-route>
    <mist-list selectable id="teamsList"
                items="[[model.teamsArray]]"
                name="Teams"
                frozen=[[_getFrozenLogColumn()]]
                visible=[[_getVisibleColumns()]]
                renderers=[[_getRenderers(model.teams,model.members)]]
                route={{route}}
                primary-field-name="id" hidden$=[[!_isListActive(route.path)]]></mist-list>

    <team-page model="[[model]]" team$="[[_getTeam(data.team, model.teams)]]" section="[[model.sections.teams]]" hidden$=[[!_isDetailsPageActive(route.path)]]></team-page>
    <members-add model="[[model]]" params="[[data]]" section="[[model.sections.teams]]" hidden$=[[!_isAddMembersPageActive(route.path)]]></members-add>
    <member-add-in-teams model="[[model]]" params="[[data]]" section="[[model.sections.teams]]" hidden$=[[!_isAddMemberPageActive(route.path)]]></member-add-in-teams>

  </template>

  <script>
    Polymer({

      is: 'page-teams',

      properties: {
        model: Object
      },

      attached: function() {

      },

      _isDetailsPageActive: function(path) {
          return path && !path.endsWith('+add');
      },
      _isAddMembersPageActive: function(path) {
          return path != '/+add' && path.endsWith('+add');
      },
      _isAddMemberPageActive: function(path) {
          return path == '/+add';
      },
      _isListActive: function(path) {
          return !path;
      },
      _getTeam: function(id) {
          if (this.model.teams && this.model.teams[id])
              return this.model.teams[id];
      },

      _getFrozenLogColumn: function(){
        return ['name'];
      },

      _getVisibleColumns: function(){
        return ['description', 'members', 'tags'];
      },

      _getRenderers: function(teams, members) {
        var _this = this;
        console.log('teams',teams);
        return {
            'name': {
                'body': function(item, row) {
                  console.log("item", item, row);
                  if (row.parent && _this.model && _this.model.org && _this.model.org.parent_org_name) {
                    var ret = "<strong>[" + _this.model.org.parent_org_name + "] " + item +"</strong>";
                    return ret;
                  }
                  return "<strong>"+ item + "</strong>";
                }
            },
            'members': {
                'body': function(item, row) {
                  console.log("member", item, row);
                  if (_this.model && _this.model.members && item.length && item.length > 0 ) {
                    var names = item.map(function(i){
                      if (_this.model.members[i])
                        return _this.model.members[i].name || _this.model.members[i].email;
                    })
                    var ret = names;
                    return ret;
                  }
                  return item;
                }
            }
        };
    },

    });
  </script>
</dom-module>
