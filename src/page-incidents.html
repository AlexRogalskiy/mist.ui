<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/mist-list/mist-list.html">
<link rel="import" href="helpers/mist-lists-behavior.html">
<dom-module id="page-incidents">
    <template>
        <style include="shared-styles">
            .error {
                color: #d96557;
            }

            h2[slot="header"] {
                margin: 8px;
            }
        </style>
        <app-route route="{{route}}"></app-route>
        <template is="dom-if" if="[[_isListActive(route.path)]]" restamp>
            <mist-list id="incidentsList" expands resizable column-menu multi-sort apiurl="/api/v1/incidents" items="[[model.incidentsArray]]"
                name="Incidents" selected-items="{{selectedItems}}" filtered-items-length="{{filteredItemsLength}}"
                combined-filter={{combinedFilter}} frozen=[[_getFrozenLogColumn()]] visible=[[_getVisibleColumns()]]
                renderers=[[_getRenderers()]] user-filter=[[model.sections.incidents.q]]>
                <h2 slot="header">[[filteredItemsLength]] [[combinedFilter]] Incidents </h2>
                <p slot="no-items-found">Hooray! No Incidents found.</p>
            </mist-list>
        </template>
    </template>
    <script>
        Polymer({
            is: 'page-incidents',
            behaviors: [
                mistListsBehavior
            ],
            properties: {
                model: {
                    type: Object
                }
            },
            listeners: {
                click: 'resizeList'
            },
            observers: [
                'incidentsChanged(model.incidents.*)'
            ],
            incidentsChanged: function (incidents) {
                if (incidents.path == 'model.incidents' && this.shadowRoot.querySelector('mist-list')) {
                    this.shadowRoot.querySelector('mist-list').fire('resize');
                }
            },
            _isListActive: function (path) {
                return !path;
            },
            _getFrozenLogColumn: function () {
                return ['started_at'];
            },

            _getVisibleColumns: function () {
                return ['resource_id', 'cloud_id', 'id', 'error'];
            },
            // TODO compute columns for all resources' incidents
            _getRenderers: function () {
                var _this = this;
                return {
                    'started_at': {
                        'title': function (item) {
                            return item ? item.replace(/_/g, " ") : 'started at';
                        },
                        'body': function (item, row) {
                            var active = '';
                            if (!row.finished_at) {
                                active = '<strong class="error"> - Active now </strong>'
                            }
                            return '<span title="' + moment(item * 1000).format() + '">' + moment(item *
                                1000).fromNow() + '</span>' + active;
                        }
                    },
                    'resource_id': {
                        'title': function (item) {
                            return 'resource';
                        },
                        'body': function (item, row) {
                            var resource = _this._getResource(row, _this.model);
                            // Resource may be missing. If not display link
                            if (resource.id)
                                return '<a href="/'+ resource.type +'/' + resource.id +
                                    '" class="regular" style="color: #2196F3;">' + resource.name + '</a>'
                            if (!resource.id)
                                return row[resource.type+'_id']
                        }
                    },
                    'cloud_id': {
                        'title': function (item) {
                            return item ? item.replace(/_/g, " ") : 'cloud';
                        },
                        'body': function (item, row) {
                            return _this.model.clouds && _this.model.clouds[item] ? _this.model.clouds[
                                item].title : item;
                        }
                    },
                    'error': {
                        'body': function (item, row) {
                            var classname = item ? 'error' : '';
                            return '<span class="' + classname + '">' + item + '</span>';
                        }
                    }
                }
            },
            resizeList: function (e) {
                if (e.path.indexOf(this.shadowRoot.querySelector('mist-list')))
                    this.shadowRoot.querySelector('mist-list').fire('resize');
            },
            _getResource: function(incident, model) {
                console.log(incident);
                if (this.model) {
                    // debugger;
                    // Get incident type
                    var resourceTypes = [ 'machine', 'volume',
                        'network',
                        'subnet',
                        'zone',
                        'record',
                        'key',
                        'script',
                        'schedule',
                        'team',
                        'member', 'cloud'],
                        type;
                    // Loop through types, check if incident refers to some type of resource
                    for (var i = 0; i < resourceTypes.length; i++) {
                        type = resourceTypes[i];
                        if (incident[type + '_id'])
                            break;
                        if (i == resourceTypes.length - 1)
                            type = null;
                    }
                    // Get resource
                    if (type) {
                        var resource = {};
                        // Subnets and records cannot be found under model.
                        if (['subnet','record','machines'].indexOf(type) == -1) {
                            resource = this.model[type+'s'][incident[type + '_id']];
                        }
                        // Machine incidents provide us with cloud_id and machine_id (external id)
                        if (type == 'machine') {
                            if (this.model.clouds[incident['cloud_id']])
                                resource = this.model.clouds[incident['cloud_id']][incident[type + '_id']];
                        }
                        if (type == 'subnet') {}
                        if (type == 'record') {}
                        // Add type information in object. Used to construct the link.
                        if (resource) {
                            resource.type = type;
                        }
                        // If we could not find the resource, return a missing object
                        if (!resource || !resource.id) {
                            resource = {
                                name: "missing " + type,
                                type: type
                            }
                        }
                        return resource;
                    }
                    return false;
                }
                return false;
            }
        });
    </script>
</dom-module>