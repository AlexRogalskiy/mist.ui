<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">

<dom-module id="notifications-settings">
    <template>
        <style is="custom-style" include="shared-styles forms">
            :host {
                display: block;
            }

            :host paper-material {
                display: block;
                padding: 0;
            }

            .flex-horizontal-with-ratios {
                @apply(--layout-horizontal);
            }

            .flexchild {
                @apply(--layout-flex);
            }

            label {
                color: rgba(0, 0, 0, 0.54) !important;
                font-size: 12px;
            }

            .grid-row {
                padding: 24px;
            }

            .row {
                margin-top: 6px;
                margin-bottom: 6px;
            }

            .head {
                margin-bottom: 16px;
            }

            h2.title {
                font-weight: 500;
            }

            h2.title, h2.title~p {
                margin-top: 0;
                margin-bottom: 0;
            }

            paper-radio-button {
                --paper-radio-button-checked-color: var(--paper-light-blue-500);
                --paper-radio-button-checked-ink-color: var(--paper-light-blue-500);
                --paper-radio-button-unchecked-ink-color: var(--paper-light-blue-900);
            }
            hr {
                width: 100%;
            }
            :host paper-progress{
                position: absolute;
                width: 100%;
                left: 0;
                right: 0;
            }
            
            .margin {
                margin: 32px 0;
            }

            .bottom-actions {
                padding-bottom: 24px;
                padding-left: 1rem;
            }
            .separator {
                border-top: 1px solid #ddd;
                margin: 0 0 32px 0;
            }
            .progress {
                margin: 32px 0 8px 0;
                width: 100%;
            }
            paper-progress.progresserror ::content #primaryProgress {
                background-color: var(--red-color);
            }
            .errormsg-container {
                color: var(--red-color);
                padding-left: 24px;
                padding-right: 24px
            }
            .errormsg-container iron-icon {
                color: inherit;
            }

            paper-icon-button.white {
                --paper-icon-button-ink-color: var(--paper-orange-500);
            }

            paper-icon-button.delete-avatar-icon {
                top: -12px;
            }

            iron-image.avatar-preview {
                width: 80px;
                height: 36px;
                margin: 2px 6px;
            }

            div.existing-org-logo {
                display: inline-block;
                vertical-align: middle;
                text-align: center;
            }

            div.org-logo-container {
                background-color: #2F2F3E;
                margin: 6px;
                display: inline-block
            }

            div.org-logo-field-title {
                color: var(--paper-light-blue-600);
                text-transform: uppercase;
                font-weight: 400;
                font-size: 12px;
                margin-left: -17px;
            }

            .ruleLabel {
                display: inline-flex;
                width: 30%;
                vertical-align: top;
            }

            paper-toggle-button {
                margin: auto;
                display: inline-flex;
                cursor: pointer;
                /*--paper-toggle-button-checked-bar-color: #2196F3;
                --paper-toggle-button-checked-button-color: #fff;*/
            }
        </style>
        <paper-material>
            <div class="grid-row">
                <div class="xs12 head">
                    <h2 class="title">Notifications Settings</h2>
                </div>

                <div class="ips-section xs12 m12 l12">
                    <p>Adjust how you wish to be notified of important events and recommendations regarding your infrastructure.</p>
                </div>
                <div class="separator clearfix xs12 m12 l12"></div>
                <div class="ips-section xs12 m12 l12">
                    <template is="dom-repeat" items="[[notificationRules]]" as="rule">
                        <div class="row">
                            <span class="ruleLabel">[[_computeRuleLabel(rule)]]</span>
                            <paper-toggle-button checked="{{_computeAllowed(rule)}}" on-change="_ruleChanged" index="[[index]]">
                                [[_computeRuleStateLabel(rule)]]
                            </paper-toggle-button>
                        </div>
                    </template>
                </div>
            </div>
            <div class="bottom-actions clearfix xs12">
                <div class="separator clearfix xs12 m12 l12"></div>
                <paper-button class="pull-right" 
                    disabled$="[[!formReady]]" 
                    raised on-tap="_submitForm">Save Notifications Settings</paper-button>
            </div>

        </paper-material>

        <iron-ajax auto id="getNotificationRulesRequest" 
            method="GET" 
            url="/api/v1/notification_rules" 
            on-response="_handleGetRulesResponse" 
            on-error="_handleGetRulesError" 
            handle-as="json"></iron-ajax>

       <iron-ajax id="setNotificationRulesRequest"
            url="/api/v1/notification_rules"
            method="PUT"
            on-response="_handleSetRulesResponse"
            on-error="_handleSetRulesError"
            handle-as="json"></iron-ajax>

    </template>
    <script>
        Polymer({
            is: 'notifications-settings',
            properties: {
                notificationRules: Array,
                rulesError: Boolean
            },

            _computeAllowed: function(rule) {
                return rule.value == "ALLOW";
            },

            _computeRuleLabel: function(rule) {
                var lowerCase = (rule.channel + " " + rule.source).toLowerCase();
                if (lowerCase.includes("inapp")) 
                {
                    if (lowerCase.includes("recommendation"))
                    {
                        return "In-App Recommendations";
                    }
                    return "In-App Notifications";
                }
                else if (lowerCase.includes("email"))
                {
                    return "Email Reports";
                }
            },

            _computeRuleStateLabel: function(rule) {
                var valueString = rule.value.toLowerCase();
                return valueString.charAt(0).toUpperCase() + valueString.slice(1);
            },

            _ruleChanged: function(e) {
                var checked = e.target.checked;
                var index = e.target.index;
                var newRule = JSON.parse(JSON.stringify(this.notificationRules[index]));
                newRule.value = checked ? "ALLOW" : "BLOCK";
                this.splice('notificationRules', index, 1, newRule);
            },

            _getRules: function(e, user) {
                this.$.getNotificationRulesRequest.headers["Content-Type"] = 'application/json';
                this.$.getNotificationRulesRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.getNotificationRulesRequest.generateRequest();
            },

            _handleGetRulesResponse: function(e) {
                this.set('notificationRules', JSON.parse(e.detail.response));
            },

            _handleGetRulesError: function() {
                this.set('rulesError', true);
            },

            _submitForm: function(e) {
                var payload = {
                    action: 'update_notification_rules',
                    rules: this.notificationRules
                };
                this.$.setNotificationRulesRequest.headers["Content-Type"] = 'application/json';
                this.$.setNotificationRulesRequest.headers["Csrf-Token"] = CSRF_TOKEN;
                this.$.setNotificationRulesRequest.body = payload;
                this.$.setNotificationRulesRequest.generateRequest();
            },

            _handleSetRulesResponse: function(e) {
                this.fire('toast',{msg:"Changes saved succesfully!",duration:3000});
            },

            _handleSetRulesError: function() {
                this.set('rulesError', true);
                this.$.usererrormsg.textContent = e.detail.request.xhr.responseText;
            }
        });
    </script>
</dom-module>
