<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-styles/typography.html">

<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/3.8.5/echarts.min.js" integrity="sha256-7aRWxAaH0PFLbAt5oJLWIliWFHPZWuFbCGchtzd6njk=" crossorigin="anonymous"></script>

<dom-module id="balance-chart">
    <template>
        <style is="custom-style" include="shared-styles">
        :host {
            display: block;
        }

        :host paper-material {
            display: block;
            padding: 0;
        }
        .balance {
            font-size: 2em;
        }
        .balance sub,
        .balance sup {
            font-size: .6em;
            font-weight: 300;
        }
        .balance sub {
            vertical-align: baseline;
        }
        .navigator {
            display: flex;
        }
        .navigator paper-button {
            font-size: .9em;
            background-color: #eee !important;
            margin: 8px !important;
        }
        .navigator paper-button.active{
            color: var(--accent-color) !important;
        }
        #balanceGraph {
            width: 300px;
            height: 300px;
            margin-bottom: 40px;
        }
        </style>

        <div id="balanceGraph" style="height:300px; width: 410px;"></div>
        <iron-ajax id="getBalance" auto url="/api/v1/metering" method="GET" loading="{{loadingMetering}}" on-response="_handleMeteringResponse" on-error="_handleMeteringError"></iron-ajax>
    </template>
    <script>
BALANCE_GRAPH_OPTIONS = {
    title: {
        text: 'Cores and rules checks'
    },
    tooltip: {
        trigger: 'axis',
        extraCssText: 'text-align: left',
    },
    grid: {
        left: '3%',
        right: '4%',
        bottom: '3%',
        containLabel: true
    },
    toolbox: {
        show: true,
        feature: {
            saveAsImage: {
                title: 'Save image'
            }
        },
    },
    legend: {
        show: true,
    },
    xAxis: {
        type: 'time',
        splitLine: {
            show: false
        },
        data: []
    },
    yAxis: {
        type: 'value',
    },
    series: [
        {
            name:'cores',
            type:'line',
            data:[],
        },{
            name:'checks',
            type:'line',
            data:[],
        }
    ]
};

        Polymer({
            is: 'balance-chart',

            properties: {
                isOverUsing: Boolean,
                user: {
                    type: Object
                },
                org: {
                    type: Object
                },
                plans: {
                    type: Array,
                    computed: 'computePlans(user, org)'
                },
                balanceGraph: Object,
                balanceGraphOptions: {
                    type: Object,
                    value: function() {
                        return BALANCE_GRAPH_OPTIONS;
                    }
                },
                balanceData: {
                    type: Object,
                    value: function() {
                        return {
                            balance: 124,
                            data: []
                        }
                    }
                },
            },
            listeners: {

            },
            ready: function(){
                this.initCharts();
            },
            initCharts: function() {
                var colorPalette = ['#607D8B', '#d96557', '#3F51B5', '#009688', '#795548', '#8c76d1', '#795548', '#0277BD', '#0099cc', '#424242', '#D48900', '#43A047', '#2F2F3E'];
                echarts.registerTheme('balance', {
                    color: colorPalette,
                    backgroundColor: 'transparent',
                    graph: {
                        color: colorPalette
                    }
                });
                this.balanceGraph = echarts.init(this.$.balanceGraph, 'balance');
                this.balanceGraph.setOption(this.balanceGraphOptions);
                console.log('initialized charts');
            },
            _handleMeteringResponse: function(e) {
                var data = e.detail.xhr.response;
                var timeToCores = data.map(function(d){
                    return [d.date, d.usage.cores];
                });
                var timeToChecks = data.map(function(d){
                    return [d.date, d.usage.checks];
                });
                var since = data.length ? moment(data[data.length-1][0]).format('DD MMM') : '';
                this.set('balanceGraphOptions.series.0.data', timeToCores);
                this.set('balanceGraphOptions.series.1.data', timeToChecks);
                this.balanceGraph.setOption(this.get('balanceGraphOptions'));
            },
        });
    </script>
</dom-module>