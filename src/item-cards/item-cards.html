<script type="module" src="../item-card/item-card.js"></script>
<dom-module id="item-cards">
    <template>
        <style>
    :host {
        max-width: 920px;
    }

    #cards {
        @apply --layout-horizontal;
        @apply --layout-wrap;
        margin-right: -10px;
    }
    </style>
        <div id="cards">
        </div>
    </template>
</dom-module>
<script type="module">
import '../item-card/item-card.js';
import { Polymer } from '../../../../@polymer/polymer/lib/legacy/polymer-fn.js';
import { dom } from '../../../../@polymer/polymer/lib/legacy/polymer.dom.js';

Polymer({
    is: 'item-cards',

    properties: {
        sections: {
            type: Array
        },
        items: {
            type: Array
        },
        section: {
            type: Object
        }
    },

    observers: [
        '_render(items, sections, isAttached)'
    ],

    _findAncestor(node, fn) {
        while (node && fn.call(this, node)) {
            node = node.parentNode;
        }
        return node;
    },

    _tap(e) {
        const {sourceEvent} = e.detail;
        const A = this._findAncestor(e.target, function(node) {
            return node != this && node.tagName !== 'A';
        });

        if (A && A.tagName === 'A' && A.href.indexOf(location.host) > 0) {
            if (sourceEvent.ctrlKey || sourceEvent.metaKey) {
                window.open(A.href);
            } else {
                this.dispatchEvent(new CustomEvent('nav', { bubbles: true, composed: true, detail: {
                    url: A.href
                } }));

            }
            e.preventDefault();
        }
    },

    _getColor(item) {
        return this.section.color;
    },

    _getSectionSymbol(item) {
        return this.section.symbol;
    },

    _render(items, sections) {
        if (items) {
            this.$.cards.innerHTML = '';

            let head = 0;
            let batchSize = 3;
            const flush = function() {
                if (head + batchSize >= items.length) {
                    batchSize = items.length - head;
                }

                if (batchSize <= 0) {
                    return false;
                }
                let el;
                const firstHead = head;
                const lastHead = firstHead + batchSize;

                for (; head < lastHead; head++) {
                    el = document.createElement('item-card');
                    el.item = items[head];
                    el.color = this.section.color;
                    el.sectionSymbol = this.section.symbol;
                    dom(this.$.cards).appendChild(el);
                }
                return true;
            };
            var batch = function() {
                if (flush.call(this)) {
                    batchSize = 10;
                    requestAnimationFrame(batch.bind(this));
                }
            };

            batch.call(this);
        }
    }
});
</script>
